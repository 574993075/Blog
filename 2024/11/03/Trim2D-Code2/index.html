<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Trim2D-Code2 | WangHao 's Blog</title><meta name="author" content="WangHao"><meta name="copyright" content="WangHao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Trim3D论文中2D部分的代码">
<meta property="og:type" content="article">
<meta property="og:title" content="Trim2D-Code2">
<meta property="og:url" content="http://example.com/2024/11/03/Trim2D-Code2/index.html">
<meta property="og:site_name" content="WangHao 's Blog">
<meta property="og:description" content="Trim3D论文中2D部分的代码">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2024/10/21/xPiULZOrbcWpvtz.jpg">
<meta property="article:published_time" content="2024-11-03T14:14:38.000Z">
<meta property="article:modified_time" content="2024-11-22T16:11:22.764Z">
<meta property="article:author" content="WangHao">
<meta property="article:tag" content="Trim3D">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/10/21/xPiULZOrbcWpvtz.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://example.com/2024/11/03/Trim2D-Code2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Trim2D-Code2',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-23 00:11:22'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/themes/butterfly/source/css/modify.styl"><meta name="generator" content="Hexo 7.3.0"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/Avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2024/10/21/xPiULZOrbcWpvtz.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="WangHao 's Blog"><span class="site-name">WangHao 's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Trim2D-Code2</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-11-03T14:14:38.000Z" title="Created 2024-11-03 22:14:38">2024-11-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-11-22T16:11:22.764Z" title="Updated 2024-11-23 00:11:22">2024-11-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%A7%86%E8%A7%89%E5%88%86%E6%9E%90/">视觉分析</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Trim2D-Code2"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url('https://s2.loli.net/2024/10/21/xPiULZOrbcWpvtz.jpg');"></div><article class="post-content" id="article-container"><h1 id="train-py"><a target="_blank" rel="noopener" href="http://train.py">train.py</a></h1>
<h2 id="代码主体">代码主体</h2>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> utils.loss_utils <span class="keyword">import</span> l1_loss, ssim</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> render, network_gui</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> scene <span class="keyword">import</span> Scene, GaussianModel</span><br><span class="line"><span class="keyword">from</span> utils.general_utils <span class="keyword">import</span> safe_state</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> utils.image_utils <span class="keyword">import</span> psnr</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser, Namespace</span><br><span class="line"><span class="keyword">from</span> arguments <span class="keyword">import</span> ModelParams, PipelineParams, OptimizationParams</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> torch.utils.tensorboard <span class="keyword">import</span> SummaryWriter</span><br><span class="line">    TENSORBOARD_FOUND = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    TENSORBOARD_FOUND = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">training</span>(<span class="params">dataset, opt, pipe, testing_iterations, saving_iterations, checkpoint_iterations, checkpoint</span>):</span><br><span class="line">    first_iter = <span class="number">0</span></span><br><span class="line">    tb_writer = prepare_output_and_logger(dataset)</span><br><span class="line">    gaussians = GaussianModel(dataset.sh_degree)</span><br><span class="line">    scene = Scene(dataset, gaussians)</span><br><span class="line">    gaussians.training_setup(opt)</span><br><span class="line">    <span class="keyword">if</span> checkpoint:</span><br><span class="line">        (model_params, first_iter) = torch.load(checkpoint)</span><br><span class="line">        gaussians.restore(model_params, opt)</span><br><span class="line"></span><br><span class="line">    bg_color = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>] <span class="keyword">if</span> dataset.white_background <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    background = torch.tensor(bg_color, dtype=torch.float32, device=<span class="string">"cuda"</span>)</span><br><span class="line"></span><br><span class="line">    iter_start = torch.cuda.Event(enable_timing = <span class="literal">True</span>)</span><br><span class="line">    iter_end = torch.cuda.Event(enable_timing = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    viewpoint_stack = <span class="literal">None</span></span><br><span class="line">    ema_loss_for_log = <span class="number">0.0</span></span><br><span class="line">    ema_dist_for_log = <span class="number">0.0</span></span><br><span class="line">    ema_normal_for_log = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    progress_bar = tqdm(<span class="built_in">range</span>(first_iter, opt.iterations), desc=<span class="string">"Training progress"</span>)</span><br><span class="line">    first_iter += <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> iteration <span class="keyword">in</span> <span class="built_in">range</span>(first_iter, opt.iterations + <span class="number">1</span>):        </span><br><span class="line"></span><br><span class="line">        iter_start.record()</span><br><span class="line"></span><br><span class="line">        gaussians.update_learning_rate(iteration)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Every 1000 its we increase the levels of SH up to a maximum degree</span></span><br><span class="line">        <span class="keyword">if</span> iteration % <span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">            gaussians.oneupSHdegree()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Pick a random Camera</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> viewpoint_stack:</span><br><span class="line">            viewpoint_stack = scene.getTrainCameras().copy()</span><br><span class="line">        viewpoint_cam = viewpoint_stack.pop(randint(<span class="number">0</span>, <span class="built_in">len</span>(viewpoint_stack)-<span class="number">1</span>))</span><br><span class="line">        </span><br><span class="line">        render_pkg = render(viewpoint_cam, gaussians, pipe, background)</span><br><span class="line">        image, viewspace_point_tensor, visibility_filter, radii = render_pkg[<span class="string">"render"</span>], render_pkg[<span class="string">"viewspace_points"</span>], render_pkg[<span class="string">"visibility_filter"</span>], render_pkg[<span class="string">"radii"</span>]</span><br><span class="line">        </span><br><span class="line">        gt_image = viewpoint_cam.original_image.cuda()</span><br><span class="line">        Ll1 = l1_loss(image, gt_image)</span><br><span class="line">        loss = (<span class="number">1.0</span> - opt.lambda_dssim) * Ll1 + opt.lambda_dssim * (<span class="number">1.0</span> - ssim(image, gt_image))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># regularization</span></span><br><span class="line">        lambda_normal = opt.lambda_normal <span class="keyword">if</span> iteration &gt; <span class="number">7000</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">        lambda_dist = opt.lambda_dist <span class="keyword">if</span> iteration &gt; <span class="number">3000</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">        rend_dist = render_pkg[<span class="string">"rend_dist"</span>]</span><br><span class="line">        rend_normal  = render_pkg[<span class="string">'rend_normal'</span>]</span><br><span class="line">        surf_normal = render_pkg[<span class="string">'surf_normal'</span>]</span><br><span class="line">        normal_error = (<span class="number">1</span> - (rend_normal * surf_normal).<span class="built_in">sum</span>(dim=<span class="number">0</span>))[<span class="literal">None</span>]</span><br><span class="line">        normal_loss = lambda_normal * (normal_error).mean()</span><br><span class="line">        dist_loss = lambda_dist * (rend_dist).mean()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># loss</span></span><br><span class="line">        total_loss = loss + dist_loss + normal_loss</span><br><span class="line">        </span><br><span class="line">        total_loss.backward()</span><br><span class="line"></span><br><span class="line">        iter_end.record()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            <span class="comment"># Progress bar</span></span><br><span class="line">            ema_loss_for_log = <span class="number">0.4</span> * loss.item() + <span class="number">0.6</span> * ema_loss_for_log</span><br><span class="line">            ema_dist_for_log = <span class="number">0.4</span> * dist_loss.item() + <span class="number">0.6</span> * ema_dist_for_log</span><br><span class="line">            ema_normal_for_log = <span class="number">0.4</span> * normal_loss.item() + <span class="number">0.6</span> * ema_normal_for_log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> iteration % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">                loss_dict = {</span><br><span class="line">                    <span class="string">"Loss"</span>: <span class="string">f"<span class="subst">{ema_loss_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">                    <span class="string">"distort"</span>: <span class="string">f"<span class="subst">{ema_dist_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">                    <span class="string">"normal"</span>: <span class="string">f"<span class="subst">{ema_normal_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">                    <span class="string">"Points"</span>: <span class="string">f"<span class="subst">{<span class="built_in">len</span>(gaussians.get_xyz)}</span>"</span></span><br><span class="line">                }</span><br><span class="line">                progress_bar.set_postfix(loss_dict)</span><br><span class="line"></span><br><span class="line">                progress_bar.update(<span class="number">10</span>)</span><br><span class="line">            <span class="keyword">if</span> iteration == opt.iterations:</span><br><span class="line">                progress_bar.close()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Log and save</span></span><br><span class="line">            <span class="keyword">if</span> tb_writer <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                tb_writer.add_scalar(<span class="string">'train_loss_patches/dist_loss'</span>, ema_dist_for_log, iteration)</span><br><span class="line">                tb_writer.add_scalar(<span class="string">'train_loss_patches/normal_loss'</span>, ema_normal_for_log, iteration)</span><br><span class="line"></span><br><span class="line">            training_report(tb_writer, iteration, Ll1, loss, l1_loss, iter_start.elapsed_time(iter_end), testing_iterations, scene, render, (pipe, background))</span><br><span class="line">            <span class="keyword">if</span> (iteration <span class="keyword">in</span> saving_iterations):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\n[ITER {}] Saving Gaussians"</span>.<span class="built_in">format</span>(iteration))</span><br><span class="line">                scene.save(iteration)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Densification</span></span><br><span class="line">            <span class="keyword">if</span> iteration &lt; opt.densify_until_iter:</span><br><span class="line">                gaussians.max_radii2D[visibility_filter] = torch.<span class="built_in">max</span>(gaussians.max_radii2D[visibility_filter], radii[visibility_filter])</span><br><span class="line">                gaussians.add_densification_stats(viewspace_point_tensor, visibility_filter)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> iteration &gt; opt.densify_from_iter <span class="keyword">and</span> iteration % opt.densification_interval == <span class="number">0</span>:</span><br><span class="line">                    size_threshold = <span class="number">20</span> <span class="keyword">if</span> iteration &gt; opt.opacity_reset_interval <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                    gaussians.densify_and_prune(opt.densify_grad_threshold, opt.opacity_cull, scene.cameras_extent, size_threshold)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> iteration % opt.opacity_reset_interval == <span class="number">0</span> <span class="keyword">or</span> (dataset.white_background <span class="keyword">and</span> iteration == opt.densify_from_iter):</span><br><span class="line">                    gaussians.reset_opacity()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Optimizer step</span></span><br><span class="line">            <span class="keyword">if</span> iteration &lt; opt.iterations:</span><br><span class="line">                gaussians.optimizer.step()</span><br><span class="line">                gaussians.optimizer.zero_grad(set_to_none = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (iteration <span class="keyword">in</span> checkpoint_iterations):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\n[ITER {}] Saving Checkpoint"</span>.<span class="built_in">format</span>(iteration))</span><br><span class="line">                torch.save((gaussians.capture(), iteration), scene.model_path + <span class="string">"/chkpnt"</span> + <span class="built_in">str</span>(iteration) + <span class="string">".pth"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_output_and_logger</span>(<span class="params">args</span>):    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.model_path:</span><br><span class="line">        <span class="keyword">if</span> os.getenv(<span class="string">'OAR_JOB_ID'</span>):</span><br><span class="line">            unique_str=os.getenv(<span class="string">'OAR_JOB_ID'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            unique_str = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        args.model_path = os.path.join(<span class="string">"./output/"</span>, unique_str[<span class="number">0</span>:<span class="number">10</span>])</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Set up output folder</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Output folder: {}"</span>.<span class="built_in">format</span>(args.model_path))</span><br><span class="line">    os.makedirs(args.model_path, exist_ok = <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(args.model_path, <span class="string">"cfg_args"</span>), <span class="string">'w'</span>) <span class="keyword">as</span> cfg_log_f:</span><br><span class="line">        cfg_log_f.write(<span class="built_in">str</span>(Namespace(**<span class="built_in">vars</span>(args))))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create Tensorboard writer</span></span><br><span class="line">    tb_writer = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> TENSORBOARD_FOUND:</span><br><span class="line">        tb_writer = SummaryWriter(args.model_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Tensorboard not available: not logging progress"</span>)</span><br><span class="line">    <span class="keyword">return</span> tb_writer</span><br><span class="line"></span><br><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">training_report</span>(<span class="params">tb_writer, iteration, Ll1, loss, l1_loss, elapsed, testing_iterations, scene : Scene, renderFunc, renderArgs</span>):</span><br><span class="line">    <span class="keyword">if</span> tb_writer:</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'train_loss_patches/reg_loss'</span>, Ll1.item(), iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'train_loss_patches/total_loss'</span>, loss.item(), iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'iter_time'</span>, elapsed, iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'total_points'</span>, scene.gaussians.get_xyz.shape[<span class="number">0</span>], iteration)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Report test and samples of training set</span></span><br><span class="line">    <span class="keyword">if</span> iteration <span class="keyword">in</span> testing_iterations:</span><br><span class="line">        torch.cuda.empty_cache()</span><br><span class="line">        validation_configs = ({<span class="string">'name'</span>: <span class="string">'test'</span>, <span class="string">'cameras'</span> : scene.getTestCameras()}, </span><br><span class="line">                              {<span class="string">'name'</span>: <span class="string">'train'</span>, <span class="string">'cameras'</span> : [scene.getTrainCameras()[idx % <span class="built_in">len</span>(scene.getTrainCameras())] <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">30</span>, <span class="number">5</span>)]})</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> config <span class="keyword">in</span> validation_configs:</span><br><span class="line">            <span class="keyword">if</span> config[<span class="string">'cameras'</span>] <span class="keyword">and</span> <span class="built_in">len</span>(config[<span class="string">'cameras'</span>]) &gt; <span class="number">0</span>:</span><br><span class="line">                l1_test = <span class="number">0.0</span></span><br><span class="line">                psnr_test = <span class="number">0.0</span></span><br><span class="line">                <span class="keyword">for</span> idx, viewpoint <span class="keyword">in</span> <span class="built_in">enumerate</span>(config[<span class="string">'cameras'</span>]):</span><br><span class="line">                    render_pkg = renderFunc(viewpoint, scene.gaussians, *renderArgs)</span><br><span class="line">                    image = torch.clamp(render_pkg[<span class="string">"render"</span>], <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br><span class="line">                    gt_image = torch.clamp(viewpoint.original_image.to(<span class="string">"cuda"</span>), <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br><span class="line">                    <span class="keyword">if</span> tb_writer <span class="keyword">and</span> (idx &lt; <span class="number">5</span>):</span><br><span class="line">                        <span class="keyword">from</span> utils.general_utils <span class="keyword">import</span> colormap</span><br><span class="line">                        depth = render_pkg[<span class="string">"surf_depth"</span>]</span><br><span class="line">                        norm = depth.<span class="built_in">max</span>()</span><br><span class="line">                        depth = depth / norm</span><br><span class="line">                        depth = colormap(depth.cpu().numpy()[<span class="number">0</span>], cmap=<span class="string">'turbo'</span>)</span><br><span class="line">                        tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/depth"</span>.<span class="built_in">format</span>(viewpoint.image_name), depth[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">                        tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/render"</span>.<span class="built_in">format</span>(viewpoint.image_name), image[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            rend_alpha = render_pkg[<span class="string">'rend_alpha'</span>]</span><br><span class="line">                            rend_normal = render_pkg[<span class="string">"rend_normal"</span>] * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">                            surf_normal = render_pkg[<span class="string">"surf_normal"</span>] * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_normal"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_normal[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/surf_normal"</span>.<span class="built_in">format</span>(viewpoint.image_name), surf_normal[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_alpha"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_alpha[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line"></span><br><span class="line">                            rend_dist = render_pkg[<span class="string">"rend_dist"</span>]</span><br><span class="line">                            rend_dist = colormap(rend_dist.cpu().numpy()[<span class="number">0</span>])</span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_dist"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_dist[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">                        <span class="keyword">except</span>:</span><br><span class="line">                            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> iteration == testing_iterations[<span class="number">0</span>]:</span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/ground_truth"</span>.<span class="built_in">format</span>(viewpoint.image_name), gt_image[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line"></span><br><span class="line">                    l1_test += l1_loss(image, gt_image).mean().double()</span><br><span class="line">                    psnr_test += psnr(image, gt_image).mean().double()</span><br><span class="line"></span><br><span class="line">                psnr_test /= <span class="built_in">len</span>(config[<span class="string">'cameras'</span>])</span><br><span class="line">                l1_test /= <span class="built_in">len</span>(config[<span class="string">'cameras'</span>])</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\n[ITER {}] Evaluating {}: L1 {} PSNR {}"</span>.<span class="built_in">format</span>(iteration, config[<span class="string">'name'</span>], l1_test, psnr_test))</span><br><span class="line">                <span class="keyword">if</span> tb_writer:</span><br><span class="line">                    tb_writer.add_scalar(config[<span class="string">'name'</span>] + <span class="string">'/loss_viewpoint - l1_loss'</span>, l1_test, iteration)</span><br><span class="line">                    tb_writer.add_scalar(config[<span class="string">'name'</span>] + <span class="string">'/loss_viewpoint - psnr'</span>, psnr_test, iteration)</span><br><span class="line"></span><br><span class="line">        torch.cuda.empty_cache()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Set up command line argument parser</span></span><br><span class="line">    parser = ArgumentParser(description=<span class="string">"Training script parameters"</span>)</span><br><span class="line">    lp = ModelParams(parser)</span><br><span class="line">    op = OptimizationParams(parser)</span><br><span class="line">    pp = PipelineParams(parser)</span><br><span class="line">    parser.add_argument(<span class="string">'--ip'</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">"127.0.0.1"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--port'</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">6009</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--detect_anomaly'</span>, action=<span class="string">'store_true'</span>, default=<span class="literal">False</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--test_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">7_000</span>, <span class="number">30_000</span>])</span><br><span class="line">    parser.add_argument(<span class="string">"--save_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">7_000</span>, <span class="number">30_000</span>])</span><br><span class="line">    parser.add_argument(<span class="string">"--quiet"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--checkpoint_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[])</span><br><span class="line">    parser.add_argument(<span class="string">"--start_checkpoint"</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default = <span class="literal">None</span>)</span><br><span class="line">    args = parser.parse_args(sys.argv[<span class="number">1</span>:])</span><br><span class="line">    args.save_iterations.append(args.iterations)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Optimizing "</span> + args.model_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize system state (RNG)</span></span><br><span class="line">    safe_state(args.quiet)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Start GUI server, configure and run training</span></span><br><span class="line">    <span class="comment"># network_gui.init(args.ip, args.port)</span></span><br><span class="line">    torch.autograd.set_detect_anomaly(args.detect_anomaly)</span><br><span class="line">    training(lp.extract(args), op.extract(args), pp.extract(args), args.test_iterations, args.save_iterations, args.checkpoint_iterations, args.start_checkpoint)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># All done</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\nTraining complete."</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="代码详解">代码详解</h2>
<h3 id="导入所需模块">导入所需模块</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> utils.loss_utils <span class="keyword">import</span> l1_loss, ssim</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> render, network_gui</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> scene <span class="keyword">import</span> Scene, GaussianModel</span><br><span class="line"><span class="keyword">from</span> utils.general_utils <span class="keyword">import</span> safe_state</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> utils.image_utils <span class="keyword">import</span> psnr</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser, Namespace</span><br><span class="line"><span class="keyword">from</span> arguments <span class="keyword">import</span> ModelParams, PipelineParams, OptimizationParams</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>os</code>: 提供文件系统和操作系统交互的工具。</li>
<li><code>torch</code>: 深度学习框架 PyTorch，用于张量运算和模型训练。</li>
<li><code>randint</code>: 随机数生成，用于随机选择视角。</li>
<li><code>l1_loss</code> 和 <code>ssim</code>: 自定义损失函数。</li>
<li><code>render</code>, <code>network_gui</code>: 自定义的渲染和网络GUI工具。</li>
<li><code>Scene</code>, <code>GaussianModel</code>: 定义场景和高斯模型的类。</li>
<li><code>safe_state</code>: 自定义函数，用于初始化或保存状态。</li>
<li><code>uuid</code>: 用于生成唯一的字符串标识符。</li>
<li><code>tqdm</code>: 进度条库，用于显示训练进度。</li>
<li><code>psnr</code>: 图像质量度量指标。</li>
<li><code>ArgumentParser</code>, <code>Namespace</code>: 用于命令行参数解析。</li>
<li><code>ModelParams</code>, <code>PipelineParams</code>, <code>OptimizationParams</code>: 自定义参数类，用于管理训练、管道和优化参数。</li>
</ul>
<h3 id="tensorboard-支持检测">TensorBoard 支持检测</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> torch.utils.tensorboard <span class="keyword">import</span> SummaryWriter</span><br><span class="line">    TENSORBOARD_FOUND = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    TENSORBOARD_FOUND = <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure>
<p>尝试导入<code>SummaryWriter</code>以支持 TensorBoard 日志记录。如果安装了 TensorBoard 则设置<code>TENSORBOARD_FOUND = True</code>，否则设置为<code>False</code></p>
<h3 id="training-函数"><code>training()</code> 函数</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">training</span>(<span class="params">dataset, opt, pipe, testing_iterations, saving_iterations, checkpoint_iterations, checkpoint</span>):</span><br></pre></td></tr></tbody></table></figure>
<p>定义主训练函数，接收以下参数：</p>
<ul>
<li><code>dataset</code>: 数据集对象。</li>
<li><code>opt</code>: 优化参数。</li>
<li><code>pipe</code>: 渲染管道参数。</li>
<li><code>testing_iterations</code>: 需要测试的迭代次数列表。</li>
<li><code>saving_iterations</code>: 保存模型的迭代次数列表。</li>
<li><code>checkpoint_iterations</code>: 检查点保存的迭代次数列表。</li>
<li><code>checkpoint</code>: 现有的模型检查点路径（如果有）。</li>
</ul>
<h4 id="函数内部代码逐行解释">函数内部代码逐行解释</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">first_iter = <span class="number">0</span></span><br><span class="line">tb_writer = prepare_output_and_logger(dataset)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>first_iter</code>: 初始化第一个迭代次数为 0。</li>
<li><code>tb_writer</code>: 调用 <code>prepare_output_and_logger</code> 函数创建日志记录器和输出目录。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gaussians = GaussianModel(dataset.sh_degree)</span><br><span class="line">scene = Scene(dataset, gaussians)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>gaussians</code>: 创建高斯模型对象，基于数据集中的SH度数初始化。</li>
<li><code>scene</code>: 创建场景对象，将数据集和高斯模型关联。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gaussians.training_setup(opt)</span><br></pre></td></tr></tbody></table></figure>
<p>调用 <code>gaussians</code> 的 <code>training_setup</code> 函数，使用提供的优化参数 <code>opt</code> 设置训练环境。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> checkpoint:</span><br><span class="line">    (model_params, first_iter) = torch.load(checkpoint)</span><br><span class="line">    gaussians.restore(model_params, opt)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果提供了检查点文件路径，加载检查点中的模型参数并恢复到 <code>gaussians</code> 模型中，并更新迭代计数。</li>
</ul>
<h4 id="背景设置">背景设置</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bg_color = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>] <span class="keyword">if</span> dataset.white_background <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">background = torch.tensor(bg_color, dtype=torch.float32, device=<span class="string">"cuda"</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>根据数据集设置背景颜色为白色或黑色，将其转换为张量格式并存储在GPU上。</li>
</ul>
<hr>
<h4 id="定时器和变量初始化">定时器和变量初始化</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iter_start = torch.cuda.Event(enable_timing = <span class="literal">True</span>)</span><br><span class="line">iter_end = torch.cuda.Event(enable_timing = <span class="literal">True</span>)</span><br><span class="line">viewpoint_stack = <span class="literal">None</span></span><br><span class="line">ema_loss_for_log = <span class="number">0.0</span></span><br><span class="line">ema_dist_for_log = <span class="number">0.0</span></span><br><span class="line">ema_normal_for_log = <span class="number">0.0</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>初始化CUDA事件 <code>iter_start</code> 和 <code>iter_end</code> 用于记录每次迭代的时间。</li>
<li><code>viewpoint_stack</code> 是一个用于存储视角的栈。</li>
<li><code>ema_loss_for_log</code>, <code>ema_dist_for_log</code>, <code>ema_normal_for_log</code> 用于计算损失、距离和法向量的指数移动平均（EMA）值，以便更平滑地显示日志。</li>
</ul>
<hr>
<h4 id="进度条设置">进度条设置</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">progress_bar = tqdm(<span class="built_in">range</span>(first_iter, opt.iterations), desc=<span class="string">"Training progress"</span>)</span><br><span class="line">first_iter += <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>progress_bar</code>: 使用 <code>tqdm</code> 创建一个带进度条的迭代器，显示训练进度。</li>
<li><code>first_iter</code> 增加1，用于记录下次迭代的起点。</li>
</ul>
<hr>
<h4 id="主训练循环">主训练循环</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> iteration <span class="keyword">in</span> <span class="built_in">range</span>(first_iter, opt.iterations + <span class="number">1</span>):        </span><br><span class="line">    iter_start.record()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>训练循环，从<code>first_iter</code>到指定的最大迭代次数<code>opt.iterations</code>。</li>
<li>记录每次迭代的起始时间。</li>
</ul>
<hr>
<h4 id="动态学习率调整">动态学习率调整</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gaussians.update_learning_rate(iteration)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>动态调整学习率，每次迭代调用 <code>update_learning_rate</code> 函数。</li>
</ul>
<hr>
<h4 id="sh-度数增加">SH 度数增加</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> iteration % <span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">    gaussians.oneupSHdegree()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>每隔 1000 次迭代，增加一次SH度数，提升模型的表现力。</li>
</ul>
<hr>
<h4 id="选择随机视角">选择随机视角</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> viewpoint_stack:</span><br><span class="line">    viewpoint_stack = scene.getTrainCameras().copy()</span><br><span class="line">viewpoint_cam = viewpoint_stack.pop(randint(<span class="number">0</span>, <span class="built_in">len</span>(viewpoint_stack)-<span class="number">1</span>))</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果 <code>viewpoint_stack</code> 为空，从场景对象中获取所有训练摄像头，并随机选择一个视角。</li>
</ul>
<hr>
<h4 id="渲染和损失计算">渲染和损失计算</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">render_pkg = render(viewpoint_cam, gaussians, pipe, background)</span><br><span class="line">image, viewspace_point_tensor, visibility_filter, radii = render_pkg[<span class="string">"render"</span>], render_pkg[<span class="string">"viewspace_points"</span>], render_pkg[<span class="string">"visibility_filter"</span>], render_pkg[<span class="string">"radii"</span>]</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>使用渲染函数 <code>render</code> 渲染当前视角，并得到渲染图像、视点、可见性过滤器、半径等信息。</li>
</ul>
<hr>
<h4 id="计算l1和ssim损失">计算L1和SSIM损失</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gt_image = viewpoint_cam.original_image.cuda()</span><br><span class="line">Ll1 = l1_loss(image, gt_image)</span><br><span class="line">loss = (<span class="number">1.0</span> - opt.lambda_dssim) * Ll1 + opt.lambda_dssim * (<span class="number">1.0</span> - ssim(image, gt_image))</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>将目标图像加载到GPU。</li>
<li>计算L1损失和SSIM损失并加权，得到 <code>loss</code>。</li>
</ul>
<h3 id="正则化计算">正则化计算</h3>
<p>在模型训练过程中加入正则化项，可以帮助模型更好地泛化并防止过拟合。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lambda_normal = opt.lambda_normal <span class="keyword">if</span> iteration &gt; <span class="number">7000</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">lambda_dist = opt.lambda_dist <span class="keyword">if</span> iteration &gt; <span class="number">3000</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>lambda_normal</code> 和 <code>lambda_dist</code> 控制正则化强度。</li>
<li>在训练早期（7000次和3000次迭代前），这些正则化项设为0，以便模型先学习主要特征。</li>
</ul>
<hr>
<h4 id="法向量误差和距离误差">法向量误差和距离误差</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rend_dist = render_pkg[<span class="string">"rend_dist"</span>]</span><br><span class="line">rend_normal  = render_pkg[<span class="string">'rend_normal'</span>]</span><br><span class="line">surf_normal = render_pkg[<span class="string">'surf_normal'</span>]</span><br><span class="line">normal_error = (<span class="number">1</span> - (rend_normal * surf_normal).<span class="built_in">sum</span>(dim=<span class="number">0</span>))[<span class="literal">None</span>]</span><br><span class="line">normal_loss = lambda_normal * (normal_error).mean()</span><br><span class="line">dist_loss = lambda_dist * (rend_dist).mean()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>rend_dist</code>: 渲染距离张量。</li>
<li><code>rend_normal</code> 和 <code>surf_normal</code>: 渲染图像中的法向量和表面法向量。</li>
<li><code>normal_error</code>: 计算法向量误差，主要使用点积法向量，结果在0到1之间（1为理想匹配）。</li>
<li><code>normal_loss</code> 和 <code>dist_loss</code>: 加权的正则化损失，用于控制模型的法向量一致性和距离约束。</li>
</ul>
<hr>
<h4 id="总损失和反向传播">总损失和反向传播</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">total_loss = loss + dist_loss + normal_loss</span><br><span class="line">total_loss.backward()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>total_loss</code>: 总损失，包含主要的图像损失和正则化损失。</li>
<li><code>total_loss.backward()</code>: 反向传播计算梯度，用于更新模型参数。</li>
</ul>
<hr>
<h4 id="记录每次迭代的时间">记录每次迭代的时间</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iter_end.record()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>iter_end.record()</code>: 记录迭代结束时间，用于计算和日志记录。</li>
</ul>
<hr>
<h3 id="指数移动平均-ema-计算">指数移动平均（EMA）计算</h3>
<p>EMA 用于平滑损失值，便于观察训练趋势。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    ema_loss_for_log = <span class="number">0.4</span> * loss.item() + <span class="number">0.6</span> * ema_loss_for_log</span><br><span class="line">    ema_dist_for_log = <span class="number">0.4</span> * dist_loss.item() + <span class="number">0.6</span> * ema_dist_for_log</span><br><span class="line">    ema_normal_for_log = <span class="number">0.4</span> * normal_loss.item() + <span class="number">0.6</span> * ema_normal_for_log</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>使用<code>0.4</code>和<code>0.6</code>的权重更新EMA值，平滑训练损失，以便后续在进度条中展示。</li>
</ul>
<hr>
<h4 id="更新进度条信息">更新进度条信息</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> iteration % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">    loss_dict = {</span><br><span class="line">        <span class="string">"Loss"</span>: <span class="string">f"<span class="subst">{ema_loss_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">        <span class="string">"distort"</span>: <span class="string">f"<span class="subst">{ema_dist_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">        <span class="string">"normal"</span>: <span class="string">f"<span class="subst">{ema_normal_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">        <span class="string">"Points"</span>: <span class="string">f"<span class="subst">{<span class="built_in">len</span>(gaussians.get_xyz)}</span>"</span></span><br><span class="line">    }</span><br><span class="line">    progress_bar.set_postfix(loss_dict)</span><br><span class="line">    progress_bar.update(<span class="number">10</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>每隔10次迭代更新进度条信息，包括平滑后的损失值和高斯模型中的点数量。</li>
</ul>
<hr>
<h4 id="tensorboard-日志记录">TensorBoard 日志记录</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> tb_writer <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    tb_writer.add_scalar(<span class="string">'train_loss_patches/dist_loss'</span>, ema_dist_for_log, iteration)</span><br><span class="line">    tb_writer.add_scalar(<span class="string">'train_loss_patches/normal_loss'</span>, ema_normal_for_log, iteration)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果 TensorBoard 启用了日志记录，每次迭代记录当前的距离和法向量损失。</li>
</ul>
<hr>
<h3 id="调用-training-report-函数">调用 <code>training_report</code> 函数</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">training_report(tb_writer, iteration, Ll1, loss, l1_loss, iter_start.elapsed_time(iter_end), testing_iterations, scene, render, (pipe, background))</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>调用 <code>training_report</code> 函数记录迭代信息，记录训练和测试集的渲染结果。</li>
</ul>
<hr>
<h4 id="保存高斯模型">保存高斯模型</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (iteration <span class="keyword">in</span> saving_iterations):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\\n[ITER {}] Saving Gaussians"</span>.<span class="built_in">format</span>(iteration))</span><br><span class="line">    scene.save(iteration)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果当前迭代属于指定的保存迭代，将高斯模型保存到指定路径。</li>
</ul>
<hr>
<h4 id="执行密度增强">执行密度增强</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> iteration &lt; opt.densify_until_iter:</span><br><span class="line">    gaussians.max_radii2D[visibility_filter] = torch.<span class="built_in">max</span>(gaussians.max_radii2D[visibility_filter], radii[visibility_filter])</span><br><span class="line">    gaussians.add_densification_stats(viewspace_point_tensor, visibility_filter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> iteration &gt; opt.densify_from_iter <span class="keyword">and</span> iteration % opt.densification_interval == <span class="number">0</span>:</span><br><span class="line">        size_threshold = <span class="number">20</span> <span class="keyword">if</span> iteration &gt; opt.opacity_reset_interval <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        gaussians.densify_and_prune(opt.densify_grad_threshold, opt.opacity_cull, scene.cameras_extent, size_threshold)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>max_radii2D</code>：记录最大的半径，适应可见性过滤。</li>
<li>如果在密度增强间隔内，调用<code>densify_and_prune</code> 执行增强操作，控制高斯模型的密度分布，逐渐增强模型分辨率。</li>
</ul>
<hr>
<h4 id="清除不透明度">清除不透明度</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> iteration % opt.opacity_reset_interval == <span class="number">0</span> <span class="keyword">or</span> (dataset.white_background <span class="keyword">and</span> iteration == opt.densify_from_iter):</span><br><span class="line">    gaussians.reset_opacity()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>每隔 <code>opacity_reset_interval</code> 次迭代重置不透明度，或在指定迭代初始化时对背景为白色的数据集进行重置。</li>
</ul>
<hr>
<h3 id="优化步骤">优化步骤</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> iteration &lt; opt.iterations:</span><br><span class="line">    gaussians.optimizer.step()</span><br><span class="line">    gaussians.optimizer.zero_grad(set_to_none = <span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>更新优化器参数，并清除梯度，以准备下一次迭代。</li>
</ul>
<hr>
<h4 id="检查点保存">检查点保存</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (iteration <span class="keyword">in</span> checkpoint_iterations):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\\n[ITER {}] Saving Checkpoint"</span>.<span class="built_in">format</span>(iteration))</span><br><span class="line">    torch.save((gaussians.capture(), iteration), scene.model_path + <span class="string">"/chkpnt"</span> + <span class="built_in">str</span>(iteration) + <span class="string">".pth"</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果当前迭代属于检查点列表，保存当前模型的状态，以便后续恢复训练。</li>
</ul>
<hr>
<h3 id="prepare-output-and-logger-函数"><code>prepare_output_and_logger()</code> 函数</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_output_and_logger</span>(<span class="params">args</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.model_path:</span><br><span class="line">        <span class="keyword">if</span> os.getenv(<span class="string">'OAR_JOB_ID'</span>):</span><br><span class="line">            unique_str=os.getenv(<span class="string">'OAR_JOB_ID'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            unique_str = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        args.model_path = os.path.join(<span class="string">"./output/"</span>, unique_str[<span class="number">0</span>:<span class="number">10</span>])</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>检查是否设置了模型输出路径。</li>
<li>如果未设置则生成唯一路径 <code>model_path</code>。</li>
</ul>
<hr>
<h4 id="输出文件夹创建">输出文件夹创建</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"Output folder: {}"</span>.<span class="built_in">format</span>(args.model_path))</span><br><span class="line">os.makedirs(args.model_path, exist_ok = <span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>在指定路径中创建输出文件夹。</li>
</ul>
<hr>
<h4 id="配置日志记录">配置日志记录</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tb_writer = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> TENSORBOARD_FOUND:</span><br><span class="line">    tb_writer = SummaryWriter(args.model_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Tensorboard not available: not logging progress"</span>)</span><br><span class="line"><span class="keyword">return</span> tb_writer</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果安装了TensorBoard，则创建 <code>SummaryWriter</code> 对象以支持日志记录。</li>
<li>否则输出提示信息，不记录日志。</li>
</ul>
<hr>
<h3 id="training-report-函数"><code>training_report()</code> 函数</h3>
<p>该函数生成训练过程中的报告，主要用于TensorBoard可视化。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">training_report</span>(<span class="params">tb_writer, iteration, Ll1, loss, l1_loss, elapsed, testing_iterations, scene : Scene, renderFunc, renderArgs</span>):</span><br></pre></td></tr></tbody></table></figure>
<h4 id="测试和训练集渲染">测试和训练集渲染</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">validation_configs = ({<span class="string">'name'</span>: <span class="string">'test'</span>, <span class="string">'cameras'</span> : scene.getTestCameras()}, </span><br><span class="line">                      {<span class="string">'name'</span>: <span class="string">'train'</span>, <span class="string">'cameras'</span> : [scene.getTrainCameras()[idx % <span class="built_in">len</span>(scene.getTrainCameras())] <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">30</span>, <span class="number">5</span>)]})</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>定义测试集和训练集的渲染配置，每5次迭代从训练集中采样摄像头。</li>
</ul>
<h4 id="逐个相机计算l1和psnr误差">逐个相机计算L1和PSNR误差</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> config <span class="keyword">in</span> validation_configs:</span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">'cameras'</span>] <span class="keyword">and</span> <span class="built_in">len</span>(config[<span class="string">'cameras'</span>]) &gt; <span class="number">0</span>:</span><br><span class="line">        l1_test = <span class="number">0.0</span></span><br><span class="line">        psnr_test = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">for</span> idx, viewpoint <span class="keyword">in</span> <span class="built_in">enumerate</span>(config[<span class="string">'cameras'</span>]):</span><br><span class="line">            render_pkg = renderFunc(viewpoint, scene.gaussians, *renderArgs)</span><br><span class="line">            image = torch.clamp(render_pkg[<span class="string">"render"</span>], <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br><span class="line">            gt_image = torch.clamp(viewpoint.original_image.to(<span class="string">"cuda"</span>), <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>对每个相机视角计算渲染图像和真实图像之间的L1和PSNR误差。</li>
</ul>
<hr>
<h3 id="主入口">主入口</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Set up command line argument parser</span></span><br><span class="line">    parser = ArgumentParser(description=<span class="string">"Training script parameters"</span>)</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># Initialize system state (RNG)</span></span><br><span class="line">    safe_state(args.quiet)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Start GUI server, configure and run training</span></span><br><span class="line">    training(...)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>初始化命令行参数并调用 <code>training()</code> 开始训练</li>
</ul>
<h1 id="cull-pcd-py">cull_pcd.py</h1>
<h2 id="代码主体">代码主体</h2>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> scene <span class="keyword">import</span> Scene</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> makedirs</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</span><br><span class="line"><span class="keyword">from</span> arguments <span class="keyword">import</span> ModelParams, PipelineParams, get_combined_args</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> GaussianModel</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cull_pcd</span>(<span class="params">dataset : ModelParams, iteration : <span class="built_in">int</span>, pipeline : PipelineParams</span>):</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        gaussians = GaussianModel(dataset.sh_degree)</span><br><span class="line">        scene = Scene(dataset, gaussians, load_iteration=iteration, shuffle=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        train_cameras = scene.getTrainCameras()</span><br><span class="line"></span><br><span class="line">        bg_color = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>] <span class="keyword">if</span> dataset.white_background <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        background = torch.tensor(bg_color, dtype=torch.float32, device=<span class="string">"cuda"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            prune_mask = torch.zeros(gaussians.get_xyz.shape[<span class="number">0</span>], dtype=torch.<span class="built_in">bool</span>, device=<span class="string">"cuda"</span>)</span><br><span class="line">            <span class="keyword">for</span> view <span class="keyword">in</span> train_cameras:</span><br><span class="line">                p_homo = gaussians.get_xyz @ view.full_proj_transform[:<span class="number">3</span>] + view.full_proj_transform[<span class="number">3</span>]</span><br><span class="line">                p_ndc = p_homo[:, :<span class="number">2</span>] / (p_homo[:, <span class="number">3</span>:<span class="number">4</span>] + <span class="number">1e-6</span>)</span><br><span class="line">                view_mask = (p_ndc[:, <span class="number">0</span>] &gt;= -<span class="number">1</span>) &amp; (p_ndc[:, <span class="number">0</span>] &lt;= <span class="number">1</span>) &amp; (p_ndc[:, <span class="number">1</span>] &gt;= -<span class="number">1</span>) &amp; (p_ndc[:, <span class="number">1</span>] &lt;= <span class="number">1</span>)</span><br><span class="line">                alpha_mask = F.grid_sample(view.gt_alpha_mask[<span class="literal">None</span>], p_ndc[view_mask][<span class="literal">None</span>, <span class="literal">None</span>], mode=<span class="string">"nearest"</span>, align_corners=<span class="literal">True</span>).squeeze() &lt; <span class="number">0.5</span></span><br><span class="line">                prune_mask[view_mask.nonzero()] |= alpha_mask.unsqueeze(-<span class="number">1</span>)</span><br><span class="line">            gaussians.prune_points_without_optimizer(prune_mask)</span><br><span class="line">        output = os.path.join(dataset.model_path, <span class="string">"point_cloud/iteration_{}"</span>.<span class="built_in">format</span>(iteration), <span class="string">"point_cloud_culled.ply"</span>)</span><br><span class="line">        gaussians.save_ply(output)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Set up command line argument parser</span></span><br><span class="line">    parser = ArgumentParser(description=<span class="string">"Testing script parameters"</span>)</span><br><span class="line">    model = ModelParams(parser, sentinel=<span class="literal">True</span>)</span><br><span class="line">    pipeline = PipelineParams(parser)</span><br><span class="line">    parser.add_argument(<span class="string">"--iteration"</span>, default=<span class="number">30000</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--quiet"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    args = get_combined_args(parser)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Rendering "</span> + args.model_path)</span><br><span class="line"></span><br><span class="line">    random.seed(<span class="number">0</span>)</span><br><span class="line">    np.random.seed(<span class="number">0</span>)</span><br><span class="line">    torch.manual_seed(<span class="number">0</span>)</span><br><span class="line">    torch.cuda.set_device(torch.device(<span class="string">"cuda:0"</span>))</span><br><span class="line"></span><br><span class="line">    cull_pcd(model.extract(args), args.iteration, pipeline.extract(args))</span><br></pre></td></tr></tbody></table></figure>
<h2 id="代码详解">代码详解</h2>
<h3 id="cull-pcd-函数"><code>cull_pcd</code> 函数</h3>
<h4 id="函数签名">函数签名</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">cull_pcd</span>(<span class="params">dataset : ModelParams, iteration : <span class="built_in">int</span>, pipeline : PipelineParams</span>):</span><br></pre></td></tr></tbody></table></figure>
<p><code>cull_pcd</code> 函数的参数为：</p>
<ul>
<li><code>dataset</code>：模型参数的配置类，用于定义点云数据的属性。</li>
<li><code>iteration</code>：迭代次数，用于决定当前剔除操作的输出文件。</li>
<li><code>pipeline</code>：管道参数配置类，用于定义点云处理流水线的属性。</li>
</ul>
<h4 id="函数内容">函数内容</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    gaussians = GaussianModel(dataset.sh_degree)</span><br><span class="line">    scene = Scene(dataset, gaussians, load_iteration=iteration, shuffle=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>torch.no_grad()</code>：在该上下文中关闭梯度计算，减少内存使用。</li>
<li><code>gaussians</code>：创建高斯模型的实例，用于表示点云。</li>
<li><code>scene</code>：创建场景对象，加载点云及其相机视角。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_cameras = scene.getTrainCameras()</span><br></pre></td></tr></tbody></table></figure>
<p>获取训练相机的视角列表。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bg_color = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>] <span class="keyword">if</span> dataset.white_background <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">background = torch.tensor(bg_color, dtype=torch.float32, device=<span class="string">"cuda"</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>根据 <code>dataset.white_background</code> 决定背景颜色为白色或黑色。</p>
<h4 id="剔除点云">剔除点云</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    prune_mask = torch.zeros(gaussians.get_xyz.shape[<span class="number">0</span>], dtype=torch.<span class="built_in">bool</span>, device=<span class="string">"cuda"</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>初始化一个布尔掩码 <code>prune_mask</code>，用于标记哪些点需要被剔除。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> view <span class="keyword">in</span> train_cameras:</span><br><span class="line">    p_homo = gaussians.get_xyz @ view.full_proj_transform[:<span class="number">3</span>] + view.full_proj_transform[<span class="number">3</span>]</span><br><span class="line">    p_ndc = p_homo[:, :<span class="number">2</span>] / (p_homo[:, <span class="number">3</span>:<span class="number">4</span>] + <span class="number">1e-6</span>)</span><br><span class="line">    view_mask = (p_ndc[:, <span class="number">0</span>] &gt;= -<span class="number">1</span>) &amp; (p_ndc[:, <span class="number">0</span>] &lt;= <span class="number">1</span>) &amp; (p_ndc[:, <span class="number">1</span>] &gt;= -<span class="number">1</span>) &amp; (p_ndc[:, <span class="number">1</span>] &lt;= <span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>遍历所有相机视角，进行以下操作：</p>
<ol>
<li><code>p_homo</code>：将点云投影到该相机的坐标系中。</li>
<li><code>p_ndc</code>：将点投影到归一化设备坐标（NDC）中。</li>
<li><code>view_mask</code>：用于判断哪些点在当前相机的视野内。</li>
</ol>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alpha_mask = F.grid_sample(view.gt_alpha_mask[<span class="literal">None</span>], p_ndc[view_mask][<span class="literal">None</span>, <span class="literal">None</span>], mode=<span class="string">"nearest"</span>, align_corners=<span class="literal">True</span>).squeeze() &lt; <span class="number">0.5</span></span><br><span class="line">prune_mask[view_mask.nonzero()] |= alpha_mask.unsqueeze(-<span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>alpha_mask</code>：将视野内的点进行采样，根据 alpha 通道判断是否需要剔除。</li>
<li><code>prune_mask</code>：更新掩码，将符合条件的点标记为需要剔除。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gaussians.prune_points_without_optimizer(prune_mask)</span><br></pre></td></tr></tbody></table></figure>
<p>根据 <code>prune_mask</code> 剔除不可见点。</p>
<h4 id="保存点云文件">保存点云文件</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">output = os.path.join(dataset.model_path, <span class="string">"point_cloud/iteration_{}"</span>.<span class="built_in">format</span>(iteration), <span class="string">"point_cloud_culled.ply"</span>)</span><br><span class="line">gaussians.save_ply(output)</span><br></pre></td></tr></tbody></table></figure>
<p>生成剔除后的点云文件的路径，并将点云数据保存为 <code>.ply</code> 文件。</p>
<h3 id="主程序">主程序</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    parser = ArgumentParser(description=<span class="string">"Testing script parameters"</span>)</span><br><span class="line">    model = ModelParams(parser, sentinel=<span class="literal">True</span>)</span><br><span class="line">    pipeline = PipelineParams(parser)</span><br><span class="line">    parser.add_argument(<span class="string">"--iteration"</span>, default=<span class="number">30000</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--quiet"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    args = get_combined_args(parser)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Rendering "</span> + args.model_path)</span><br><span class="line"></span><br><span class="line">    random.seed(<span class="number">0</span>)</span><br><span class="line">    np.random.seed(<span class="number">0</span>)</span><br><span class="line">    torch.manual_seed(<span class="number">0</span>)</span><br><span class="line">    torch.cuda.set_device(torch.device(<span class="string">"cuda:0"</span>))</span><br><span class="line"></span><br><span class="line">    cull_pcd(model.extract(args), args.iteration, pipeline.extract(args))</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>创建命令行参数解析器，设定默认迭代次数和安静模式。</li>
<li>设置随机种子，确保结果可复现。</li>
<li>指定 GPU 设备。</li>
<li>调用 <code>cull_pcd</code> 函数，执行点云剔除操作。</li>
</ul>
<h1 id="tune-py"><a target="_blank" rel="noopener" href="http://tune.py">tune.py</a></h1>
<h2 id="代码主体">代码主体</h2>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> utils.loss_utils <span class="keyword">import</span> l1_loss, ssim</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> render, network_gui</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> scene <span class="keyword">import</span> Scene, GaussianModel</span><br><span class="line"><span class="keyword">from</span> utils.general_utils <span class="keyword">import</span> safe_state</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> utils.image_utils <span class="keyword">import</span> psnr</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser, Namespace</span><br><span class="line"><span class="keyword">from</span> arguments <span class="keyword">import</span> ModelParams, PipelineParams, FinetuneParams</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> torch.utils.tensorboard <span class="keyword">import</span> SummaryWriter</span><br><span class="line">    TENSORBOARD_FOUND = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    TENSORBOARD_FOUND = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     import debugpy</span></span><br><span class="line"><span class="comment">#     debugpy.listen(5678)</span></span><br><span class="line"><span class="comment">#     print("Waiting for debugger attach")</span></span><br><span class="line"><span class="comment">#     debugpy.wait_for_client()</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">culling</span>(<span class="params">xyz, cams, expansion=<span class="number">2</span></span>):</span><br><span class="line">    cam_centers = torch.stack([c.camera_center <span class="keyword">for</span> c <span class="keyword">in</span> cams], <span class="number">0</span>).to(xyz.device)</span><br><span class="line">    span_x = cam_centers[:, <span class="number">0</span>].<span class="built_in">max</span>() - cam_centers[:, <span class="number">0</span>].<span class="built_in">min</span>()</span><br><span class="line">    span_y = cam_centers[:, <span class="number">1</span>].<span class="built_in">max</span>() - cam_centers[:, <span class="number">1</span>].<span class="built_in">min</span>() <span class="comment"># smallest span</span></span><br><span class="line">    span_z = cam_centers[:, <span class="number">2</span>].<span class="built_in">max</span>() - cam_centers[:, <span class="number">2</span>].<span class="built_in">min</span>()</span><br><span class="line"></span><br><span class="line">    scene_center = cam_centers.mean(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    span_x = span_x * expansion</span><br><span class="line">    span_y = span_y * expansion</span><br><span class="line">    span_z = span_z * expansion</span><br><span class="line"></span><br><span class="line">    x_min = scene_center[<span class="number">0</span>] - span_x / <span class="number">2</span></span><br><span class="line">    x_max = scene_center[<span class="number">0</span>] + span_x / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    y_min = scene_center[<span class="number">1</span>] - span_y / <span class="number">2</span></span><br><span class="line">    y_max = scene_center[<span class="number">1</span>] + span_y / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    z_min = scene_center[<span class="number">2</span>] - span_x / <span class="number">2</span></span><br><span class="line">    z_max = scene_center[<span class="number">2</span>] + span_x / <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    valid_mask = (xyz[:, <span class="number">0</span>] &gt; x_min) &amp; (xyz[:, <span class="number">0</span>] &lt; x_max) &amp; \</span><br><span class="line">                 (xyz[:, <span class="number">1</span>] &gt; y_min) &amp; (xyz[:, <span class="number">1</span>] &lt; y_max) &amp; \</span><br><span class="line">                 (xyz[:, <span class="number">2</span>] &gt; z_min) &amp; (xyz[:, <span class="number">2</span>] &lt; z_max)</span><br><span class="line">    <span class="comment"># print(f'scene mask ratio {valid_mask.sum().item() / valid_mask.shape[0]}')</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> valid_mask, scene_center</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prune_low_contribution_gaussians</span>(<span class="params">gaussians, cameras, pipe, bg, K=<span class="number">5</span>, prune_ratio=<span class="number">0.1</span></span>):</span><br><span class="line">    top_list = [<span class="literal">None</span>, ] * K</span><br><span class="line">    <span class="keyword">for</span> i, cam <span class="keyword">in</span> <span class="built_in">enumerate</span>(cameras):</span><br><span class="line">        trans = render(cam, gaussians, pipe, bg, record_transmittance=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> top_list[<span class="number">0</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            m = trans &gt; top_list[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> m.<span class="built_in">any</span>():</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(K - <span class="number">1</span>):</span><br><span class="line">                    top_list[K - <span class="number">1</span> - i][m] = top_list[K - <span class="number">2</span> - i][m]</span><br><span class="line">                top_list[<span class="number">0</span>][m] = trans[m]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            top_list = [trans.clone() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(K)]</span><br><span class="line"></span><br><span class="line">    contribution = torch.stack(top_list, dim=-<span class="number">1</span>).mean(-<span class="number">1</span>)</span><br><span class="line">    tile = torch.quantile(contribution, prune_ratio)</span><br><span class="line">    prune_mask = contribution &lt; tile</span><br><span class="line">    gaussians.prune_points(prune_mask)</span><br><span class="line">    torch.cuda.empty_cache()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">training</span>(<span class="params">dataset, opt, pipe, testing_iterations, saving_iterations, checkpoint_iterations, checkpoint, pretrained_ply, split</span>):</span><br><span class="line">    first_iter = <span class="number">0</span></span><br><span class="line">    tb_writer = prepare_output_and_logger(dataset)</span><br><span class="line">    model_params = <span class="string">"\n"</span>.join([<span class="string">f'<span class="subst">{k}</span>: <span class="subst">{v}</span>'</span> <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">vars</span>(dataset).items()])</span><br><span class="line">    logging.info(<span class="string">f"Model params:\n<span class="subst">{model_params}</span>"</span>)</span><br><span class="line">    fine_tune_params = <span class="string">"\n"</span>.join([<span class="string">f'<span class="subst">{k}</span>: <span class="subst">{v}</span>'</span> <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">vars</span>(opt).items()])</span><br><span class="line">    logging.info(<span class="string">f"Finetune Params:\n<span class="subst">{fine_tune_params}</span>"</span>)</span><br><span class="line">    pipe_params = <span class="string">"\n"</span>.join([<span class="string">f'<span class="subst">{k}</span>: <span class="subst">{v}</span>'</span> <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">vars</span>(pipe).items()])</span><br><span class="line">    logging.info(<span class="string">f"Pipeline params:\n<span class="subst">{pipe_params}</span>"</span>)</span><br><span class="line">    gaussians = GaussianModel(dataset.sh_degree)</span><br><span class="line">    scene = Scene(dataset, gaussians, pretrained_ply_path=pretrained_ply)</span><br><span class="line">    gaussians.training_setup(opt)</span><br><span class="line">    <span class="keyword">if</span> checkpoint:</span><br><span class="line">        (model_params, first_iter) = torch.load(checkpoint)</span><br><span class="line">        gaussians.restore(model_params, opt)</span><br><span class="line"></span><br><span class="line">    bg_color = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>] <span class="keyword">if</span> dataset.white_background <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    background = torch.tensor(bg_color, dtype=torch.float32, device=<span class="string">"cuda"</span>)</span><br><span class="line"></span><br><span class="line">    iter_start = torch.cuda.Event(enable_timing = <span class="literal">True</span>)</span><br><span class="line">    iter_end = torch.cuda.Event(enable_timing = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    viewpoint_stack = <span class="literal">None</span></span><br><span class="line">    ema_loss_for_log = <span class="number">0.0</span></span><br><span class="line">    ema_dist_for_log = <span class="number">0.0</span></span><br><span class="line">    ema_normal_for_log = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    progress_bar = tqdm(<span class="built_in">range</span>(first_iter, opt.iterations), desc=<span class="string">"Training progress"</span>)</span><br><span class="line">    first_iter += <span class="number">1</span></span><br><span class="line">    all_cameras = scene.getTrainCameras().copy()</span><br><span class="line">    <span class="keyword">for</span> iteration <span class="keyword">in</span> <span class="built_in">range</span>(first_iter, opt.iterations + <span class="number">1</span>):</span><br><span class="line"></span><br><span class="line">        iter_start.record()</span><br><span class="line"></span><br><span class="line">        gaussians.update_learning_rate(iteration)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Every 1000 its we increase the levels of SH up to a maximum degree</span></span><br><span class="line">        <span class="comment"># if iteration % 1000 == 0:</span></span><br><span class="line">        <span class="comment">#     gaussians.oneupSHdegree()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Pick a random Camera</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> viewpoint_stack:</span><br><span class="line">            viewpoint_stack = scene.getTrainCameras().copy()</span><br><span class="line">        viewpoint_cam = viewpoint_stack.pop(randint(<span class="number">0</span>, <span class="built_in">len</span>(viewpoint_stack)-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        render_pkg = render(viewpoint_cam, gaussians, pipe, background)</span><br><span class="line">        image, viewspace_point_tensor, visibility_filter, radii = render_pkg[<span class="string">"render"</span>], render_pkg[<span class="string">"viewspace_points"</span>], render_pkg[<span class="string">"visibility_filter"</span>], render_pkg[<span class="string">"radii"</span>]</span><br><span class="line"></span><br><span class="line">        gt_image = viewpoint_cam.original_image.cuda()</span><br><span class="line">        Ll1 = l1_loss(image, gt_image)</span><br><span class="line">        loss = (<span class="number">1.0</span> - opt.lambda_dssim) * Ll1 + opt.lambda_dssim * (<span class="number">1.0</span> - ssim(image, gt_image))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># regularization</span></span><br><span class="line">        lambda_normal = opt.lambda_normal</span><br><span class="line">        lambda_dist = opt.lambda_dist</span><br><span class="line"></span><br><span class="line">        rend_dist = render_pkg[<span class="string">"rend_dist"</span>]</span><br><span class="line">        rend_normal  = render_pkg[<span class="string">'rend_normal'</span>]</span><br><span class="line">        surf_normal = render_pkg[<span class="string">'surf_normal'</span>]</span><br><span class="line"></span><br><span class="line">        depth_map = render_pkg[<span class="string">"surf_depth"</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> opt.depth_grad_thresh &gt; <span class="number">0</span>:</span><br><span class="line">            depth_map_for_grad = depth_map[<span class="literal">None</span>, <span class="literal">None</span>]</span><br><span class="line">            sobel_kernel_x = torch.tensor([[-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>], [-<span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>], [-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>]], dtype=depth_map.dtype, device=depth_map.device).view(<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line">            sobel_kernel_y = torch.tensor([[-<span class="number">1</span>, -<span class="number">2</span>, -<span class="number">1</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]], dtype=depth_map.dtype, device=depth_map.device).view(<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">            depth_map_for_grad = F.pad(depth_map_for_grad, pad=(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>), mode=<span class="string">"replicate"</span>)</span><br><span class="line">            depth_grad_x = F.conv2d(depth_map_for_grad, sobel_kernel_x) / <span class="number">3</span></span><br><span class="line">            depth_grad_y = F.conv2d(depth_map_for_grad, sobel_kernel_y) / <span class="number">3</span></span><br><span class="line">            depth_grad_mag = torch.sqrt(depth_grad_x ** <span class="number">2</span> + depth_grad_y ** <span class="number">2</span>)</span><br><span class="line">            depth_grad_weight = (depth_grad_mag &lt; opt.depth_grad_thresh).<span class="built_in">float</span>()</span><br><span class="line">            <span class="keyword">if</span> opt.depth_grad_mask_dilation &gt; <span class="number">0</span>:</span><br><span class="line">                mask_di = opt.depth_grad_mask_dilation</span><br><span class="line">                depth_grad_weight = -<span class="number">1</span> * F.max_pool2d(-<span class="number">1</span> * depth_grad_weight, mask_di * <span class="number">2</span> + <span class="number">1</span>, stride=<span class="number">1</span>, padding=mask_di)</span><br><span class="line">            depth_grad_weight = depth_grad_weight.squeeze().detach()</span><br><span class="line">            normal_error = (<span class="number">1</span> - (rend_normal * surf_normal).<span class="built_in">sum</span>(dim=<span class="number">0</span>)) * depth_grad_weight</span><br><span class="line">            normal_error = normal_error[<span class="literal">None</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            normal_error = (<span class="number">1</span> - (rend_normal * surf_normal).<span class="built_in">sum</span>(dim=<span class="number">0</span>))[<span class="literal">None</span>]</span><br><span class="line">        normal_loss = lambda_normal * (normal_error).mean()</span><br><span class="line">        dist_loss = lambda_dist * (rend_dist).mean()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># loss</span></span><br><span class="line">        total_loss = loss + dist_loss + normal_loss</span><br><span class="line"></span><br><span class="line">        total_loss.backward()</span><br><span class="line"></span><br><span class="line">        iter_end.record()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            <span class="comment"># Progress bar</span></span><br><span class="line">            ema_loss_for_log = <span class="number">0.4</span> * loss.item() + <span class="number">0.6</span> * ema_loss_for_log</span><br><span class="line">            ema_dist_for_log = <span class="number">0.4</span> * dist_loss.item() + <span class="number">0.6</span> * ema_dist_for_log</span><br><span class="line">            ema_normal_for_log = <span class="number">0.4</span> * normal_loss.item() + <span class="number">0.6</span> * ema_normal_for_log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> iteration % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">                loss_dict = {</span><br><span class="line">                    <span class="string">"Loss"</span>: <span class="string">f"<span class="subst">{ema_loss_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">                    <span class="string">"distort"</span>: <span class="string">f"<span class="subst">{ema_dist_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">                    <span class="string">"normal"</span>: <span class="string">f"<span class="subst">{ema_normal_for_log:.{<span class="number">5</span>}</span>f}"</span>,</span><br><span class="line">                    <span class="string">"Points"</span>: <span class="string">f"<span class="subst">{<span class="built_in">len</span>(gaussians.get_xyz)}</span>"</span></span><br><span class="line">                }</span><br><span class="line">                progress_bar.set_postfix(loss_dict)</span><br><span class="line"></span><br><span class="line">                progress_bar.update(<span class="number">10</span>)</span><br><span class="line">            <span class="keyword">if</span> iteration == opt.iterations:</span><br><span class="line">                progress_bar.close()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Log and save</span></span><br><span class="line">            <span class="keyword">if</span> tb_writer <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                tb_writer.add_scalar(<span class="string">'train_loss_patches/dist_loss'</span>, ema_dist_for_log, iteration)</span><br><span class="line">                tb_writer.add_scalar(<span class="string">'train_loss_patches/normal_loss'</span>, ema_normal_for_log, iteration)</span><br><span class="line"></span><br><span class="line">            training_report(tb_writer, iteration, Ll1, loss, l1_loss, iter_start.elapsed_time(iter_end), testing_iterations, scene, render, (pipe, background))</span><br><span class="line">            <span class="keyword">if</span> (iteration <span class="keyword">in</span> saving_iterations):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\n[ITER {}] Saving Gaussians"</span>.<span class="built_in">format</span>(iteration))</span><br><span class="line">                scene.save(iteration)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Densification</span></span><br><span class="line">            <span class="keyword">if</span> iteration &lt; opt.densify_until_iter:</span><br><span class="line">                gaussians.max_radii2D[visibility_filter] = torch.<span class="built_in">max</span>(gaussians.max_radii2D[visibility_filter], radii[visibility_filter])</span><br><span class="line">                gaussians.add_densification_stats(viewspace_point_tensor, visibility_filter)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> iteration &gt; opt.densify_from_iter <span class="keyword">and</span> iteration % opt.densification_interval == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> split == <span class="string">"ordinary"</span>:</span><br><span class="line">                        gaussians.densify_and_prune(opt.densify_grad_threshold, opt.opacity_cull, scene.cameras_extent, max_screen_size=opt.max_screen_size)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">elif</span> split == <span class="string">"scale"</span>:</span><br><span class="line">                        scene_mask, scene_center = culling(gaussians.get_xyz, scene.getTrainCameras())</span><br><span class="line">                        gaussians.densify_and_scale_split(opt.densify_grad_threshold, opt.opacity_cull, scene.cameras_extent, opt.max_screen_size, opt.densify_scale_factor, scene_mask, N=<span class="number">3</span>, no_grad=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">elif</span> split == <span class="string">"mix"</span>:</span><br><span class="line">                        gaussians.densify_and_prune(opt.densify_grad_threshold, opt.opacity_cull, scene.cameras_extent, opt.max_screen_size)</span><br><span class="line">                        scene_mask, scene_center = culling(gaussians.get_xyz, scene.getTrainCameras())</span><br><span class="line">                        gaussians.densify_and_scale_split(opt.densify_grad_threshold, opt.opacity_cull, scene.cameras_extent, opt.max_screen_size, opt.densify_scale_factor, scene_mask, N=<span class="number">3</span>, no_grad=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">elif</span> split == <span class="string">"none"</span>:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">raise</span> ValueError(<span class="string">f"Unknown split type <span class="subst">{split}</span>"</span>)</span><br><span class="line">                    <span class="keyword">if</span> iteration &gt; opt.contribution_prune_from_iter <span class="keyword">and</span> iteration % opt.contribution_prune_interval == <span class="number">0</span>:</span><br><span class="line">                        prune_low_contribution_gaussians(gaussians, all_cameras, pipe, background, K=<span class="number">5</span>, prune_ratio=opt.contribution_prune_ratio)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f'Num gs after contribution prune: <span class="subst">{<span class="built_in">len</span>(gaussians.get_xyz)}</span>'</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> iteration % opt.opacity_reset_interval == <span class="number">0</span> <span class="keyword">or</span> (dataset.white_background <span class="keyword">and</span> iteration == opt.densify_from_iter):</span><br><span class="line">                    gaussians.reset_opacity()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Optimizer step</span></span><br><span class="line">            <span class="keyword">if</span> iteration &lt; opt.iterations:</span><br><span class="line">                gaussians.optimizer.step()</span><br><span class="line">                gaussians.optimizer.zero_grad(set_to_none = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (iteration <span class="keyword">in</span> checkpoint_iterations):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\n[ITER {}] Saving Checkpoint"</span>.<span class="built_in">format</span>(iteration))</span><br><span class="line">                torch.save((gaussians.capture(), iteration), scene.model_path + <span class="string">"/chkpnt"</span> + <span class="built_in">str</span>(iteration) + <span class="string">".pth"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_output_and_logger</span>(<span class="params">args</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.model_path:</span><br><span class="line">        <span class="keyword">if</span> os.getenv(<span class="string">'OAR_JOB_ID'</span>):</span><br><span class="line">            unique_str=os.getenv(<span class="string">'OAR_JOB_ID'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            unique_str = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        args.model_path = os.path.join(<span class="string">"./output/"</span>, unique_str[<span class="number">0</span>:<span class="number">10</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set up output folder</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Output folder: {}"</span>.<span class="built_in">format</span>(args.model_path))</span><br><span class="line">    os.makedirs(args.model_path, exist_ok = <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(args.model_path, <span class="string">"cfg_args"</span>), <span class="string">'w'</span>) <span class="keyword">as</span> cfg_log_f:</span><br><span class="line">        cfg_log_f.write(<span class="built_in">str</span>(Namespace(**<span class="built_in">vars</span>(args))))</span><br><span class="line"></span><br><span class="line">    logging.basicConfig(filename=os.path.join(args.model_path, <span class="string">"training.log"</span>), level=logging.INFO)</span><br><span class="line">    <span class="comment"># Create Tensorboard writer</span></span><br><span class="line">    tb_writer = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> TENSORBOARD_FOUND:</span><br><span class="line">        tb_writer = SummaryWriter(args.model_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Tensorboard not available: not logging progress"</span>)</span><br><span class="line">    <span class="keyword">return</span> tb_writer</span><br><span class="line"></span><br><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">training_report</span>(<span class="params">tb_writer, iteration, Ll1, loss, l1_loss, elapsed, testing_iterations, scene : Scene, renderFunc, renderArgs</span>):</span><br><span class="line">    <span class="keyword">if</span> tb_writer:</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'train_loss_patches/reg_loss'</span>, Ll1.item(), iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'train_loss_patches/total_loss'</span>, loss.item(), iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'iter_time'</span>, elapsed, iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'total_points'</span>, scene.gaussians.get_xyz.shape[<span class="number">0</span>], iteration)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Report test and samples of training set</span></span><br><span class="line">    <span class="keyword">if</span> iteration <span class="keyword">in</span> testing_iterations:</span><br><span class="line">        torch.cuda.empty_cache()</span><br><span class="line">        validation_configs = ({<span class="string">'name'</span>: <span class="string">'test'</span>, <span class="string">'cameras'</span> : scene.getTestCameras()},</span><br><span class="line">                              {<span class="string">'name'</span>: <span class="string">'train'</span>, <span class="string">'cameras'</span> : [scene.getTrainCameras()[idx % <span class="built_in">len</span>(scene.getTrainCameras())] <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">30</span>, <span class="number">5</span>)]})</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> config <span class="keyword">in</span> validation_configs:</span><br><span class="line">            <span class="keyword">if</span> config[<span class="string">'cameras'</span>] <span class="keyword">and</span> <span class="built_in">len</span>(config[<span class="string">'cameras'</span>]) &gt; <span class="number">0</span>:</span><br><span class="line">                l1_test = <span class="number">0.0</span></span><br><span class="line">                psnr_test = <span class="number">0.0</span></span><br><span class="line">                <span class="keyword">for</span> idx, viewpoint <span class="keyword">in</span> <span class="built_in">enumerate</span>(config[<span class="string">'cameras'</span>]):</span><br><span class="line">                    render_pkg = renderFunc(viewpoint, scene.gaussians, *renderArgs)</span><br><span class="line">                    image = torch.clamp(render_pkg[<span class="string">"render"</span>], <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br><span class="line">                    gt_image = torch.clamp(viewpoint.original_image.to(<span class="string">"cuda"</span>), <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br><span class="line">                    <span class="keyword">if</span> tb_writer <span class="keyword">and</span> (idx &lt; <span class="number">5</span>):</span><br><span class="line">                        <span class="keyword">from</span> utils.general_utils <span class="keyword">import</span> colormap</span><br><span class="line">                        depth = render_pkg[<span class="string">"surf_depth"</span>]</span><br><span class="line">                        norm = depth.<span class="built_in">max</span>()</span><br><span class="line">                        depth = depth / norm</span><br><span class="line">                        depth = colormap(depth.cpu().numpy()[<span class="number">0</span>], cmap=<span class="string">'turbo'</span>)</span><br><span class="line">                        tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/depth"</span>.<span class="built_in">format</span>(viewpoint.image_name), depth[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">                        tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/render"</span>.<span class="built_in">format</span>(viewpoint.image_name), image[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            rend_alpha = render_pkg[<span class="string">'rend_alpha'</span>]</span><br><span class="line">                            rend_normal = render_pkg[<span class="string">"rend_normal"</span>] * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">                            surf_normal = render_pkg[<span class="string">"surf_normal"</span>] * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_normal"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_normal[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/surf_normal"</span>.<span class="built_in">format</span>(viewpoint.image_name), surf_normal[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_alpha"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_alpha[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line"></span><br><span class="line">                            rend_dist = render_pkg[<span class="string">"rend_dist"</span>]</span><br><span class="line">                            rend_dist = colormap(rend_dist.cpu().numpy()[<span class="number">0</span>])</span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_dist"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_dist[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">                        <span class="keyword">except</span>:</span><br><span class="line">                            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> iteration == testing_iterations[<span class="number">0</span>]:</span><br><span class="line">                            tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/ground_truth"</span>.<span class="built_in">format</span>(viewpoint.image_name), gt_image[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line"></span><br><span class="line">                    l1_test += l1_loss(image, gt_image).mean().double()</span><br><span class="line">                    psnr_test += psnr(image, gt_image).mean().double()</span><br><span class="line"></span><br><span class="line">                psnr_test /= <span class="built_in">len</span>(config[<span class="string">'cameras'</span>])</span><br><span class="line">                l1_test /= <span class="built_in">len</span>(config[<span class="string">'cameras'</span>])</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\n[ITER {}] Evaluating {}: L1 {} PSNR {}"</span>.<span class="built_in">format</span>(iteration, config[<span class="string">'name'</span>], l1_test, psnr_test))</span><br><span class="line">                <span class="keyword">if</span> tb_writer:</span><br><span class="line">                    tb_writer.add_scalar(config[<span class="string">'name'</span>] + <span class="string">'/loss_viewpoint - l1_loss'</span>, l1_test, iteration)</span><br><span class="line">                    tb_writer.add_scalar(config[<span class="string">'name'</span>] + <span class="string">'/loss_viewpoint - psnr'</span>, psnr_test, iteration)</span><br><span class="line"></span><br><span class="line">        torch.cuda.empty_cache()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Set up command line argument parser</span></span><br><span class="line">    parser = ArgumentParser(description=<span class="string">"Training script parameters"</span>)</span><br><span class="line">    lp = ModelParams(parser)</span><br><span class="line">    op = FinetuneParams(parser)</span><br><span class="line">    pp = PipelineParams(parser)</span><br><span class="line">    parser.add_argument(<span class="string">'--ip'</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">"127.0.0.1"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--port'</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">6009</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--detect_anomaly'</span>, action=<span class="string">'store_true'</span>, default=<span class="literal">False</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--test_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">7_000</span>, <span class="number">30_000</span>])</span><br><span class="line">    parser.add_argument(<span class="string">"--save_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">7_000</span>, <span class="number">30_000</span>])</span><br><span class="line">    parser.add_argument(<span class="string">"--quiet"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--checkpoint_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[])</span><br><span class="line">    parser.add_argument(<span class="string">"--start_checkpoint"</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default = <span class="literal">None</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--pretrained_ply"</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default = <span class="literal">None</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--split"</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default = <span class="string">"mix"</span>)</span><br><span class="line">    args = parser.parse_args(sys.argv[<span class="number">1</span>:])</span><br><span class="line">    args.save_iterations.append(args.iterations)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Optimizing "</span> + args.model_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize system state (RNG)</span></span><br><span class="line">    safe_state(args.quiet)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Start GUI server, configure and run training</span></span><br><span class="line">    <span class="comment"># network_gui.init(args.ip, args.port)</span></span><br><span class="line">    torch.autograd.set_detect_anomaly(args.detect_anomaly)</span><br><span class="line">    training(lp.extract(args), op.extract(args), pp.extract(args), args.test_iterations, args.save_iterations, args.checkpoint_iterations, args.start_checkpoint, args.pretrained_ply, args.split)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># All done</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\nTraining complete."</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="代码详解">代码详解</h2>
<h3 id="culling-函数"><code>culling</code> 函数</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">culling</span>(<span class="params">xyz, cams, expansion=<span class="number">2</span></span>):</span><br><span class="line">    cam_centers = torch.stack([c.camera_center <span class="keyword">for</span> c <span class="keyword">in</span> cams], <span class="number">0</span>).to(xyz.device)</span><br><span class="line">    span_x = cam_centers[:, <span class="number">0</span>].<span class="built_in">max</span>() - cam_centers[:, <span class="number">0</span>].<span class="built_in">min</span>()</span><br><span class="line">    span_y = cam_centers[:, <span class="number">1</span>].<span class="built_in">max</span>() - cam_centers[:, <span class="number">1</span>].<span class="built_in">min</span>()</span><br><span class="line">    span_z = cam_centers[:, <span class="number">2</span>].<span class="built_in">max</span>() - cam_centers[:, <span class="number">2</span>].<span class="built_in">min</span>()</span><br><span class="line"></span><br><span class="line">    scene_center = cam_centers.mean(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    span_x = span_x * expansion</span><br><span class="line">    span_y = span_y * expansion</span><br><span class="line">    span_z = span_z * expansion</span><br><span class="line"></span><br><span class="line">    x_min = scene_center[<span class="number">0</span>] - span_x / <span class="number">2</span></span><br><span class="line">    x_max = scene_center[<span class="number">0</span>] + span_x / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    y_min = scene_center[<span class="number">1</span>] - span_y / <span class="number">2</span></span><br><span class="line">    y_max = scene_center[<span class="number">1</span>] + span_y / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    z_min = scene_center[<span class="number">2</span>] - span_x / <span class="number">2</span></span><br><span class="line">    z_max = scene_center[<span class="number">2</span>] + span_x / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    valid_mask = (xyz[:, <span class="number">0</span>] &gt; x_min) &amp; (xyz[:, <span class="number">0</span>] &lt; x_max) &amp; \</span><br><span class="line">                 (xyz[:, <span class="number">1</span>] &gt; y_min) &amp; (xyz[:, <span class="number">1</span>] &lt; y_max) &amp; \</span><br><span class="line">                 (xyz[:, <span class="number">2</span>] &gt; z_min) &amp; (xyz[:, <span class="number">2</span>] &lt; z_max)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> valid_mask, scene_center</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>culling</code> 函数：该函数用于根据相机位置和视角过滤掉不在场景内的三维点（xyz）它通过计算所有相机位置的最小和最大坐标，定义一个包含所有相机视角范围的立方体区域。
<ul>
<li><code>expansion</code>：控制是否扩展这个范围。默认值为<code>2</code>，意味着选择的范围是相机位置最小和最大坐标的两倍。</li>
<li><code>valid_mask</code>：返回的掩码，标识哪些点在有效范围内。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="prune-low-contribution-gaussians-函数"><code>prune_low_contribution_gaussians</code> 函数</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prune_low_contribution_gaussians</span>(<span class="params">gaussians, cameras, pipe, bg, K=<span class="number">5</span>, prune_ratio=<span class="number">0.1</span></span>):</span><br><span class="line">    top_list = [<span class="literal">None</span>, ] * K</span><br><span class="line">    <span class="keyword">for</span> i, cam <span class="keyword">in</span> <span class="built_in">enumerate</span>(cameras):</span><br><span class="line">        trans = render(cam, gaussians, pipe, bg, record_transmittance=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> top_list[<span class="number">0</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            m = trans &gt; top_list[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> m.<span class="built_in">any</span>():</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(K - <span class="number">1</span>):</span><br><span class="line">                    top_list[K - <span class="number">1</span> - i][m] = top_list[K - <span class="number">2</span> - i][m]</span><br><span class="line">                top_list[<span class="number">0</span>][m] = trans[m]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            top_list = [trans.clone() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(K)]</span><br><span class="line"></span><br><span class="line">    contribution = torch.stack(top_list, dim=-<span class="number">1</span>).mean(-<span class="number">1</span>)</span><br><span class="line">    tile = torch.quantile(contribution, prune_ratio)</span><br><span class="line">    prune_mask = contribution &lt; tile</span><br><span class="line">    gaussians.prune_points(prune_mask)</span><br><span class="line">    torch.cuda.empty_cache()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>prune_low_contribution_gaussians</code> 函数：该函数根据渲染结果去除对渲染贡献较小的高斯点。它计算每个点的贡献度，并根据贡献度对点进行筛选。
<ul>
<li><code>K=5</code>：用于保持前5个贡献最大的点。</li>
<li><code>prune_ratio=0.1</code>：用于确定是否去除哪些贡献较小的点，具体根据贡献度的百分位数来决定。</li>
<li><code>gaussians.prune_points(prune_mask)</code>：实际去除低贡献的点。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="training-函数"><code>training</code> 函数</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">training</span>(<span class="params">dataset, opt, pipe, testing_iterations, saving_iterations, checkpoint_iterations, checkpoint, pretrained_ply, split</span>):</span><br><span class="line">    first_iter = <span class="number">0</span></span><br><span class="line">    tb_writer = prepare_output_and_logger(dataset)</span><br><span class="line">    model_params = <span class="string">"\n"</span>.join([<span class="string">f'<span class="subst">{k}</span>: <span class="subst">{v}</span>'</span> <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">vars</span>(dataset).items()])</span><br><span class="line">    logging.info(<span class="string">f"Model params:\n<span class="subst">{model_params}</span>"</span>)</span><br><span class="line">    fine_tune_params = <span class="string">"\n"</span>.join([<span class="string">f'<span class="subst">{k}</span>: <span class="subst">{v}</span>'</span> <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">vars</span>(opt).items()])</span><br><span class="line">    logging.info(<span class="string">f"Finetune Params:\n<span class="subst">{fine_tune_params}</span>"</span>)</span><br><span class="line">    pipe_params = <span class="string">"\n"</span>.join([<span class="string">f'<span class="subst">{k}</span>: <span class="subst">{v}</span>'</span> <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">vars</span>(pipe).items()])</span><br><span class="line">    logging.info(<span class="string">f"Pipeline params:\n<span class="subst">{pipe_params}</span>"</span>)</span><br><span class="line">    gaussians = GaussianModel(dataset.sh_degree)</span><br><span class="line">    scene = Scene(dataset, gaussians, pretrained_ply_path=pretrained_ply)</span><br><span class="line">    gaussians.training_setup(opt)</span><br><span class="line">    <span class="keyword">if</span> checkpoint:</span><br><span class="line">        (model_params, first_iter) = torch.load(checkpoint)</span><br><span class="line">        gaussians.restore(model_params, opt)</span><br><span class="line"></span><br><span class="line">    bg_color = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>] <span class="keyword">if</span> dataset.white_background <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    background = torch.tensor(bg_color, dtype=torch.float32, device=<span class="string">"cuda"</span>)</span><br><span class="line"></span><br><span class="line">    iter_start = torch.cuda.Event(enable_timing = <span class="literal">True</span>)</span><br><span class="line">    iter_end = torch.cuda.Event(enable_timing = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    viewpoint_stack = <span class="literal">None</span></span><br><span class="line">    ema_loss_for_log = <span class="number">0.0</span></span><br><span class="line">    ema_dist_for_log = <span class="number">0.0</span></span><br><span class="line">    ema_normal_for_log = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    progress_bar = tqdm(<span class="built_in">range</span>(first_iter, opt.iterations), desc=<span class="string">"Training progress"</span>)</span><br><span class="line">    first_iter += <span class="number">1</span></span><br><span class="line">    all_cameras = scene.getTrainCameras().copy()</span><br><span class="line">    <span class="keyword">for</span> iteration <span class="keyword">in</span> <span class="built_in">range</span>(first_iter, opt.iterations + <span class="number">1</span>):</span><br><span class="line">        iter_start.record()</span><br><span class="line"></span><br><span class="line">        gaussians.update_learning_rate(iteration)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> viewpoint_stack:</span><br><span class="line">            viewpoint_stack = scene.getTrainCameras().copy()</span><br><span class="line">        viewpoint_cam = viewpoint_stack.pop(randint(<span class="number">0</span>, <span class="built_in">len</span>(viewpoint_stack)-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        render_pkg = render(viewpoint_cam, gaussians, pipe, background)</span><br><span class="line">        image, viewspace_point_tensor, visibility_filter, radii = render_pkg[<span class="string">"render"</span>], render_pkg[<span class="string">"viewspace_points"</span>], render_pkg[<span class="string">"visibility_filter"</span>], render_pkg[<span class="string">"radii"</span>]</span><br><span class="line"></span><br><span class="line">        gt_image = viewpoint_cam.original_image.cuda()</span><br><span class="line">        Ll1 = l1_loss(image, gt_image)</span><br><span class="line">        loss = (<span class="number">1.0</span> - opt.lambda_dssim) * Ll1 + opt.lambda_dssim * (<span class="number">1.0</span> - ssim(image, gt_image))</span><br><span class="line"></span><br><span class="line">        lambda_normal = opt.lambda_normal</span><br><span class="line">        lambda_dist = opt.lambda_dist</span><br><span class="line"></span><br><span class="line">        rend_dist = render_pkg[<span class="string">"rend_dist"</span>]</span><br><span class="line">        rend_normal  = render_pkg[<span class="string">'rend_normal'</span>]</span><br><span class="line">        surf_normal = render_pkg[<span class="string">'surf_normal'</span>]</span><br><span class="line"></span><br><span class="line">        depth_map = render_pkg[<span class="string">"surf_depth"</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> opt.depth_grad_thresh &gt; <span class="number">0</span>:</span><br><span class="line">            depth_map_for_grad = depth_map[<span class="literal">None</span>, <span class="literal">None</span>]</span><br><span class="line">            sobel_kernel_x = torch.tensor([[-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>], [-<span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>], [-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>]], dtype=depth_map.dtype, device=depth_map.device).view(<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line">            sobel_kernel_y = torch.tensor([[-<span class="number">1</span>, -<span class="number">2</span>, -<span class="number">1</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]], dtype=depth_map.dtype, device=depth_map.device).view(<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">            depth_map_for_grad = F.pad(depth_map_for_grad, pad=(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>), mode=<span class="string">"replicate"</span>)</span><br><span class="line">            depth_grad_x = F.conv2d(depth_map_for_grad, sobel_kernel_x) / <span class="number">3</span></span><br><span class="line">            depth_grad_y = F.conv2d(depth_map_for_grad, sobel_kernel_y) / <span class="number">3</span></span><br><span class="line">            depth_grad_mag = torch.sqrt(depth_grad_x ** <span class="number">2</span> + depth_grad_y ** <span class="number">2</span>)</span><br><span class="line">            depth_grad_weight = (depth_grad_mag &lt; opt.depth_grad_thresh).<span class="built_in">float</span>()</span><br><span class="line">            <span class="keyword">if</span> opt.depth_grad_mask_dilation &gt; <span class="number">0</span>:</span><br><span class="line">                mask_di = opt.depth_grad_mask_dilation</span><br><span class="line">                depth_grad_weight = F.max_pool2d(depth_grad_weight, kernel_size=mask_di, stride=<span class="number">1</span>, padding=mask_di // <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            depth_grad_weight = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        dist_loss = (rend_dist - depth_map) ** <span class="number">2</span></span><br><span class="line">        normal_loss = (surf_normal - rend_normal) ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        loss += lambda_dist * torch.<span class="built_in">sum</span>(dist_loss * depth_grad_weight) / (torch.<span class="built_in">sum</span>(depth_grad_weight) + <span class="number">1e-6</span>)</span><br><span class="line">        loss += lambda_normal * torch.<span class="built_in">sum</span>(normal_loss * visibility_filter) / (torch.<span class="built_in">sum</span>(visibility_filter) + <span class="number">1e-6</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> torch.isnan(loss):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"NaN loss at iteration <span class="subst">{iteration}</span>"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        loss.backward()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> iteration % opt.max_grad_norm_iterations == <span class="number">0</span>:</span><br><span class="line">            torch.nn.utils.clip_grad_norm_(gaussians.parameters(), <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">        pipe.optimizer.step()</span><br><span class="line">        pipe.optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">        iter_end.record()</span><br><span class="line">        torch.cuda.synchronize()</span><br><span class="line"></span><br><span class="line">        progress_bar.set_postfix({<span class="string">"Loss"</span>: loss.item()})</span><br><span class="line">        progress_bar.update(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> iteration % testing_iterations == <span class="number">0</span>:</span><br><span class="line">            evaluate_on_test_set(iteration, gaussians, pipe, scene, tb_writer, dataset)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> iteration % saving_iterations == <span class="number">0</span>:</span><br><span class="line">            safe_state(gaussians, pipe, iteration)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> iteration % checkpoint_iterations == <span class="number">0</span>:</span><br><span class="line">            torch.save(gaussians.state_dict(), checkpoint)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> gaussians</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>training</code> 函数：这是训练过程的核心函数。它管理模型的训练流程，包括：
<ul>
<li>读取数据集、初始化高斯模型和场景。</li>
<li>每个训练迭代中：
<ul>
<li>随机选择一个相机，渲染该视角下的图像。</li>
<li>计算L1损失和SSIM损失，组合成总损失。</li>
<li>计算深度损失、法线损失，并根据权重对损失进行加权。</li>
<li>反向传播并更新模型。</li>
</ul>
</li>
<li>每隔指定迭代次数：
<ul>
<li>评估模型。</li>
<li>保存模型的状态。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="prepare-output-and-logger-函数"><code>prepare_output_and_logger</code> 函数</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_output_and_logger</span>(<span class="params">dataset</span>):</span><br><span class="line">    output_dir = os.path.join(dataset.root_dir, <span class="string">"outputs"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">        os.makedirs(output_dir)</span><br><span class="line">    tb_writer = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> TENSORBOARD_FOUND:</span><br><span class="line">        tb_writer = SummaryWriter(log_dir=output_dir)</span><br><span class="line">    <span class="keyword">return</span> tb_writer</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong><code>prepare_output_and_logger</code> 函数</strong>：该函数设置输出目录并返回一个TensorBoard的<code>SummaryWriter</code>对象，用于记录训练过程中的日志。</li>
</ul>
<h3 id="training-report-函数"><code>training_report</code> 函数</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">training_report</span>(<span class="params">tb_writer, iteration, Ll1, loss, l1_loss, elapsed, testing_iterations, scene: Scene, renderFunc, renderArgs</span>):</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>
<p><strong><code>@torch.no_grad()</code></strong>：装饰器，表示在这个函数中不需要计算梯度，节省内存和加快计算速度。</p>
</li>
<li>
<p>函数参数</p>
<p>：</p>
<ul>
<li><code>tb_writer</code>：TensorBoard的写入器，用于记录训练信息。</li>
<li><code>iteration</code>：当前训练的迭代次数。</li>
<li><code>Ll1</code>：L1损失值。</li>
<li><code>loss</code>：总损失值。</li>
<li><code>l1_loss</code>：L1损失计算函数。</li>
<li><code>elapsed</code>：当前迭代的耗时。</li>
<li><code>testing_iterations</code>：指定的测试迭代次数。</li>
<li><code>scene</code>：场景对象，包含高斯模型等信息。</li>
<li><code>renderFunc</code>：渲染函数，用于生成图像。</li>
<li><code>renderArgs</code>：渲染函数的其他参数。</li>
</ul>
</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> tb_writer:</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'train_loss_patches/reg_loss'</span>, Ll1.item(), iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'train_loss_patches/total_loss'</span>, loss.item(), iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'iter_time'</span>, elapsed, iteration)</span><br><span class="line">        tb_writer.add_scalar(<span class="string">'total_points'</span>, scene.gaussians.get_xyz.shape[<span class="number">0</span>], iteration)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>记录训练损失</strong>：如果<code>tb_writer</code>存在，使用它记录当前迭代的L1损失、总损失、迭代时间和当前有效点的总数。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Report test and samples of training set</span></span><br><span class="line">    <span class="keyword">if</span> iteration <span class="keyword">in</span> testing_iterations:</span><br><span class="line">        torch.cuda.empty_cache()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>在指定迭代进行测试</strong>：如果当前迭代是指定的测试迭代之一，清空CUDA缓存，以释放显存。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">validation_configs = ({<span class="string">'name'</span>: <span class="string">'test'</span>, <span class="string">'cameras'</span>: scene.getTestCameras()},</span><br><span class="line">{<span class="string">'name'</span>: <span class="string">'train'</span>, <span class="string">'cameras'</span>: [scene.getTrainCameras()[idx % <span class="built_in">len</span>(scene.getTrainCameras())] <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">30</span>, <span class="number">5</span>)]})</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>定义验证配置</strong>：包括测试和训练的相机配置。测试相机从<code>scene</code>中获取，而训练相机则从训练相机中选择5到30的间隔索引。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> config <span class="keyword">in</span> validation_configs:</span><br><span class="line">	<span class="keyword">if</span> config[<span class="string">'cameras'</span>] <span class="keyword">and</span> <span class="built_in">len</span>(config[<span class="string">'cameras'</span>]) &gt; <span class="number">0</span>:</span><br><span class="line">		l1_test = <span class="number">0.0</span></span><br><span class="line">         psnr_test = <span class="number">0.0</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>遍历每个配置</strong>：如果当前配置中有相机，则初始化L1和PSNR测试指标。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> idx, viewpoint <span class="keyword">in</span> <span class="built_in">enumerate</span>(config[<span class="string">'cameras'</span>]):</span><br><span class="line">	render_pkg = renderFunc(viewpoint, scene.gaussians, *renderArgs)</span><br><span class="line">	image = torch.clamp(render_pkg[<span class="string">"render"</span>], <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br><span class="line">	gt_image = torch.clamp(viewpoint.original_image.to(<span class="string">"cuda"</span>), <span class="number">0.0</span>, <span class="number">1.0</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>渲染图像</strong>：对于每个相机视角，使用提供的渲染函数生成图像，并将其裁剪到[0, 1]范围。</li>
<li><code>gt_image</code>是相机的原始图像，也进行类似裁剪处理。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> tb_writer <span class="keyword">and</span> (idx &lt; <span class="number">5</span>):</span><br><span class="line">	<span class="keyword">from</span> utils.general_utils <span class="keyword">import</span> colormap</span><br><span class="line">	depth = render_pkg[<span class="string">"surf_depth"</span>]</span><br><span class="line">	norm = depth.<span class="built_in">max</span>()</span><br><span class="line">	depth = depth / norm</span><br><span class="line">	depth = colormap(depth.cpu().numpy()[<span class="number">0</span>], cmap=<span class="string">'turbo'</span>)</span><br><span class="line">	tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/depth"</span>.<span class="built_in">format</span>(viewpoint.image_name), depth[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">	tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/render"</span>.<span class="built_in">format</span>(viewpoint.image_name), image[<span class="literal">None</span>], global_step=iteration)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>记录深度和渲染图像</strong>：如果<code>tb_writer</code>存在并且当前索引小于5，将深度图和渲染图记录到TensorBoard中。深度图首先标准化，然后应用颜色映射。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">try</span>:</span><br><span class="line">	rend_alpha = render_pkg[<span class="string">'rend_alpha'</span>]</span><br><span class="line">	rend_normal = render_pkg[<span class="string">"rend_normal"</span>] * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line">	surf_normal = render_pkg[<span class="string">"surf_normal"</span>] * <span class="number">0.5</span> + <span class="number">0.5</span></span><br><span class="line"> 	tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_normal"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_normal[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">	tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/surf_normal"</span>.<span class="built_in">format</span>(viewpoint.image_name), surf_normal[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">	tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_alpha"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_alpha[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line">	rend_dist = render_pkg[<span class="string">"rend_dist"</span>]</span><br><span class="line">	rend_dist = colormap(rend_dist.cpu().numpy()[<span class="number">0</span>])</span><br><span class="line">	tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/rend_dist"</span>.<span class="built_in">format</span>(viewpoint.image_name), rend_dist[<span class="literal">None</span>], global_step=iteration)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>记录其他渲染信息</strong>：尝试记录渲染的透明度、法线和距离图。如果有异常，直接跳过。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> iteration == testing_iterations[<span class="number">0</span>]:</span><br><span class="line">	tb_writer.add_images(config[<span class="string">'name'</span>] + <span class="string">"_view_{}/ground_truth"</span>.<span class="built_in">format</span>(viewpoint.image_name), gt_image[<span class="literal">None</span>], global_step=iteration)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>记录真值图像</strong>：如果当前迭代是测试迭代中的第一个，则记录相机的原始图像。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l1_test += l1_loss(image, gt_image).mean().double()</span><br><span class="line">	psnr_test += psnr(image, gt_image).mean().double()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>计算测试损失</strong>：累加当前渲染图像和真实图像之间的L1损失和PSNR值。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">psnr_test /= <span class="built_in">len</span>(config[<span class="string">'cameras'</span>])</span><br><span class="line">	l1_test /= <span class="built_in">len</span>(config[<span class="string">'cameras'</span>])</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"\n[ITER {}] Evaluating {}: L1 {} PSNR {}"</span>.<span class="built_in">format</span>(iteration, config[<span class="string">'name'</span>], l1_test, psnr_test))</span><br><span class="line">	<span class="keyword">if</span> tb_writer:</span><br><span class="line">		tb_writer.add_scalar(config[<span class="string">'name'</span>] + <span class="string">'/loss_viewpoint - l1_loss'</span>, l1_test, iteration)</span><br><span class="line">		tb_writer.add_scalar(config[<span class="string">'name'</span>] + <span class="string">'/loss_viewpoint - psnr'</span>, psnr_test, iteration)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>输出和记录测试结果</strong>：计算并输出平均L1损失和PSNR，若存在<code>tb_writer</code>，则记录到TensorBoard。</li>
</ul>
<hr>
<h3 id="主程序部分">主程序部分</h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Set up command line argument parser</span></span><br><span class="line">    parser = ArgumentParser(description=<span class="string">"Training script parameters"</span>)</span><br><span class="line">    lp = ModelParams(parser)</span><br><span class="line">    op = FinetuneParams(parser)</span><br><span class="line">    pp = PipelineParams(parser)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>主程序入口</strong>：设置命令行参数解析器，定义模型参数、微调参数和管道参数。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">parser.add_argument(<span class="string">'--ip'</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">"127.0.0.1"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--port'</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">6009</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--detect_anomaly'</span>, action=<span class="string">'store_true'</span>, default=<span class="literal">False</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--test_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">7_000</span>, <span class="number">30_000</span>])</span><br><span class="line">    parser.add_argument(<span class="string">"--save_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">7_000</span>, <span class="number">30_000</span>])</span><br><span class="line">    parser.add_argument(<span class="string">"--quiet"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--checkpoint_iterations"</span>, nargs=<span class="string">"+"</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[])</span><br><span class="line">    parser.add_argument(<span class="string">"--start_checkpoint"</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--pretrained_ply"</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--split"</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">"mix"</span>)</span><br><span class="line">    args = parser.parse_args(sys.argv[<span class="number">1</span>:])</span><br><span class="line">    args.save_iterations.append(args.iterations)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>添加参数</strong>：定义了一系列命令行参数，控制训练过程的各个方面，例如IP地址、端口、是否检测异常、测试和保存的迭代次数等。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"Optimizing "</span> + args.model_path)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>输出正在优化的模型路径</strong>：打印当前正在优化的模型路径。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize system state (RNG)</span></span><br><span class="line">   safe_state(args.quiet)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>初始化系统状态</strong>：调用<code>safe_state</code>函数，设置随机数生成器的状态，可能是为了复现性。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start GUI server, configure and run training</span></span><br><span class="line">   <span class="comment"># network_gui.init(args.ip, args.port)</span></span><br><span class="line">   torch.autograd.set_detect_anomaly(args.detect_anomaly)</span><br><span class="line">   training(lp.extract(args), op.extract(args), pp.extract(args), args.test_iterations, args.save_iterations, args.checkpoint_iterations, args.start_checkpoint, args.pretrained_ply, args.split)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>设置并运行训练</strong>：根据命令行参数配置并启动训练过程。GUI服务器的代码被注释掉了，表明可能不需要图形界面。</li>
</ul>
<hr>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># All done</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\nTraining complete."</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>训练完成输出</strong>：训练结束后打印信息</li>
</ul>
<h1 id="render-py"><a target="_blank" rel="noopener" href="http://render.py">render.py</a></h1>
<h2 id="代码主体">代码主体</h2>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> scene <span class="keyword">import</span> Scene</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> makedirs</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">from</span> utils.general_utils <span class="keyword">import</span> safe_state</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</span><br><span class="line"><span class="keyword">from</span> arguments <span class="keyword">import</span> ModelParams, PipelineParams, get_combined_args</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> GaussianModel</span><br><span class="line"><span class="keyword">from</span> utils.mesh_utils <span class="keyword">import</span> GaussianExtractor, to_cam_open3d, post_process_mesh</span><br><span class="line"><span class="keyword">from</span> utils.render_utils <span class="keyword">import</span> generate_path, create_videos</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> open3d <span class="keyword">as</span> o3d</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Set up command line argument parser</span></span><br><span class="line">    parser = ArgumentParser(description=<span class="string">"Testing script parameters"</span>)</span><br><span class="line">    model = ModelParams(parser, sentinel=<span class="literal">True</span>)</span><br><span class="line">    pipeline = PipelineParams(parser)</span><br><span class="line">    parser.add_argument(<span class="string">"--iteration"</span>, default=-<span class="number">1</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--skip_train"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--skip_test"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--skip_mesh"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--quiet"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--render_path"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--voxel_size"</span>, default=-<span class="number">1.0</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, <span class="built_in">help</span>=<span class="string">'Mesh: voxel size for TSDF'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--depth_trunc"</span>, default=-<span class="number">1.0</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, <span class="built_in">help</span>=<span class="string">'Mesh: Max depth range for TSDF'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--sdf_trunc"</span>, default=-<span class="number">1.0</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, <span class="built_in">help</span>=<span class="string">'Mesh: truncation value for TSDF'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--num_cluster"</span>, default=<span class="number">50</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">'Mesh: number of connected clusters to export'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--unbounded"</span>, action=<span class="string">"store_true"</span>, <span class="built_in">help</span>=<span class="string">'Mesh: using unbounded mode for meshing'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--mesh_res"</span>, default=<span class="number">1024</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">'Mesh: resolution for unbounded mesh extraction'</span>)</span><br><span class="line">    args = get_combined_args(parser)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Rendering "</span> + args.model_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    dataset, iteration, pipe = model.extract(args), args.iteration, pipeline.extract(args)</span><br><span class="line">    gaussians = GaussianModel(dataset.sh_degree)</span><br><span class="line">    scene = Scene(dataset, gaussians, load_iteration=iteration, shuffle=<span class="literal">False</span>)</span><br><span class="line">    bg_color = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>] <span class="keyword">if</span> dataset.white_background <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    background = torch.tensor(bg_color, dtype=torch.float32, device=<span class="string">"cuda"</span>)</span><br><span class="line"></span><br><span class="line">    train_dir = os.path.join(args.model_path, <span class="string">'train'</span>, <span class="string">"ours_{}"</span>.<span class="built_in">format</span>(scene.loaded_iter))</span><br><span class="line">    test_dir = os.path.join(args.model_path, <span class="string">'test'</span>, <span class="string">"ours_{}"</span>.<span class="built_in">format</span>(scene.loaded_iter))</span><br><span class="line">    gaussExtractor = GaussianExtractor(gaussians, render, pipe, bg_color=bg_color)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.skip_train:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"export training images ..."</span>)</span><br><span class="line">        os.makedirs(train_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        gaussExtractor.reconstruction(scene.getTrainCameras())</span><br><span class="line">        gaussExtractor.export_image(train_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> args.skip_test) <span class="keyword">and</span> (<span class="built_in">len</span>(scene.getTestCameras()) &gt; <span class="number">0</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"export rendered testing images ..."</span>)</span><br><span class="line">        os.makedirs(test_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        gaussExtractor.reconstruction(scene.getTestCameras())</span><br><span class="line">        gaussExtractor.export_image(test_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.render_path:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"render videos ..."</span>)</span><br><span class="line">        traj_dir = os.path.join(args.model_path, <span class="string">'traj'</span>, <span class="string">"ours_{}"</span>.<span class="built_in">format</span>(scene.loaded_iter))</span><br><span class="line">        os.makedirs(traj_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        n_fames = <span class="number">240</span></span><br><span class="line">        cam_traj = generate_path(scene.getTrainCameras(), n_frames=n_fames)</span><br><span class="line">        gaussExtractor.reconstruction(cam_traj)</span><br><span class="line">        gaussExtractor.export_image(traj_dir)</span><br><span class="line">        create_videos(base_dir=traj_dir,</span><br><span class="line">                    input_dir=traj_dir,</span><br><span class="line">                    out_name=<span class="string">'render_traj'</span>,</span><br><span class="line">                    num_frames=n_fames)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.skip_mesh:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"export mesh ..."</span>)</span><br><span class="line">        os.makedirs(train_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># set the active_sh to 0 to export only diffuse texture</span></span><br><span class="line">        gaussExtractor.gaussians.active_sh_degree = <span class="number">0</span></span><br><span class="line">        gaussExtractor.reconstruction(scene.getTrainCameras())</span><br><span class="line">        <span class="comment"># extract the mesh and save</span></span><br><span class="line">        <span class="keyword">if</span> args.unbounded:</span><br><span class="line">            name = <span class="string">'fuse_unbounded.ply'</span></span><br><span class="line">            mesh = gaussExtractor.extract_mesh_unbounded(resolution=args.mesh_res)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            name = <span class="string">'fuse.ply'</span></span><br><span class="line">            depth_trunc = (gaussExtractor.radius * <span class="number">2.0</span>) <span class="keyword">if</span> args.depth_trunc &lt; <span class="number">0</span>  <span class="keyword">else</span> args.depth_trunc</span><br><span class="line">            voxel_size = (depth_trunc / args.mesh_res) <span class="keyword">if</span> args.voxel_size &lt; <span class="number">0</span> <span class="keyword">else</span> args.voxel_size</span><br><span class="line">            sdf_trunc = <span class="number">5.0</span> * voxel_size <span class="keyword">if</span> args.sdf_trunc &lt; <span class="number">0</span> <span class="keyword">else</span> args.sdf_trunc</span><br><span class="line">            mesh = gaussExtractor.extract_mesh_bounded(voxel_size=voxel_size, sdf_trunc=sdf_trunc, depth_trunc=depth_trunc)</span><br><span class="line"></span><br><span class="line">        o3d.io.write_triangle_mesh(os.path.join(train_dir, name), mesh)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"mesh saved at {}"</span>.<span class="built_in">format</span>(os.path.join(train_dir, name)))</span><br><span class="line">        <span class="comment"># post-process the mesh and save, saving the largest N clusters</span></span><br><span class="line">        mesh_post = post_process_mesh(mesh, cluster_to_keep=args.num_cluster)</span><br><span class="line">        o3d.io.write_triangle_mesh(os.path.join(train_dir, name.replace(<span class="string">'.ply'</span>, <span class="string">'_post.ply'</span>)), mesh_post)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"mesh post processed saved at {}"</span>.<span class="built_in">format</span>(os.path.join(train_dir, name.replace(<span class="string">'.ply'</span>, <span class="string">'_post.ply'</span>))))</span><br></pre></td></tr></tbody></table></figure>
<h2 id="代码详解">代码详解</h2>
<h3 id="导入所需的库"><strong>导入所需的库</strong></h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> scene <span class="keyword">import</span> Scene</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> makedirs</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">from</span> utils.general_utils <span class="keyword">import</span> safe_state</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</span><br><span class="line"><span class="keyword">from</span> arguments <span class="keyword">import</span> ModelParams, PipelineParams, get_combined_args</span><br><span class="line"><span class="keyword">from</span> gaussian_renderer <span class="keyword">import</span> GaussianModel</span><br><span class="line"><span class="keyword">from</span> utils.mesh_utils <span class="keyword">import</span> GaussianExtractor, to_cam_open3d, post_process_mesh</span><br><span class="line"><span class="keyword">from</span> utils.render_utils <span class="keyword">import</span> generate_path, create_videos</span><br><span class="line"><span class="keyword">import</span> open3d <span class="keyword">as</span> o3d</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong><code>torch</code></strong>：用于张量操作和加速计算。</li>
<li><strong><code>Scene</code></strong>：自定义的场景类，包含摄像机、物体等3D场景相关信息。</li>
<li><strong><code>os</code> 和 <code>makedirs</code></strong>：文件路径和目录操作。</li>
<li><strong><code>tqdm</code></strong>：用于显示进度条。</li>
<li><strong><code>render</code></strong>：自定义的渲染函数，用于生成图像。</li>
<li><strong><code>torchvision</code></strong>：PyTorch的图像处理工具。</li>
<li><strong><code>safe_state</code></strong>：可能是用于设置随机种子，确保结果可复现。</li>
<li><strong><code>ArgumentParser</code></strong>：用于解析命令行参数。</li>
<li><strong><code>ModelParams</code> 和 <code>PipelineParams</code></strong>：封装模型和渲染管道的参数。</li>
<li><strong><code>GaussianModel</code></strong>：高斯模型，用于场景表示。</li>
<li><strong><code>GaussianExtractor</code></strong>：用于从高斯模型中提取图像或网格的工具。</li>
<li><strong><code>open3d</code></strong>：用于3D数据处理和可视化的库。</li>
</ul>
<hr>
<h3 id="2-主函数入口">2. <strong>主函数入口</strong></h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br></pre></td></tr></tbody></table></figure>
<p>检查脚本是否被直接运行，而不是作为模块被导入。</p>
<hr>
<h3 id="3-设置命令行参数解析器">3. <strong>设置命令行参数解析器</strong></h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parser = ArgumentParser(description=<span class="string">"Testing script parameters"</span>)</span><br><span class="line">model = ModelParams(parser, sentinel=<span class="literal">True</span>)</span><br><span class="line">pipeline = PipelineParams(parser)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong><code>ArgumentParser</code></strong>：创建命令行解析器。</li>
<li><strong><code>ModelParams</code> 和 <code>PipelineParams</code></strong>：将模型和渲染管道的参数添加到解析器中。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">parser.add_argument(<span class="string">"--iteration"</span>, default=-<span class="number">1</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--skip_train"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--skip_test"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--skip_mesh"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--quiet"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--render_path"</span>, action=<span class="string">"store_true"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--voxel_size"</span>, default=-<span class="number">1.0</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, <span class="built_in">help</span>=<span class="string">'Mesh: voxel size for TSDF'</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--depth_trunc"</span>, default=-<span class="number">1.0</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, <span class="built_in">help</span>=<span class="string">'Mesh: Max depth range for TSDF'</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--sdf_trunc"</span>, default=-<span class="number">1.0</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, <span class="built_in">help</span>=<span class="string">'Mesh: truncation value for TSDF'</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--num_cluster"</span>, default=<span class="number">50</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">'Mesh: number of connected clusters to export'</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--unbounded"</span>, action=<span class="string">"store_true"</span>, <span class="built_in">help</span>=<span class="string">'Mesh: using unbounded mode for meshing'</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--mesh_res"</span>, default=<span class="number">1024</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">'Mesh: resolution for unbounded mesh extraction'</span>)</span><br><span class="line">args = get_combined_args(parser)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>
<p>添加的参数：</p>
<ul>
<li>
<p><strong><code>--iteration</code></strong>：指定加载的迭代次数。</p>
</li>
<li>
<p><strong><code>--skip_train</code></strong>：跳过训练图像的导出。</p>
</li>
<li>
<p><strong><code>--skip_test</code></strong>：跳过测试图像的导出。</p>
</li>
<li>
<p><strong><code>--skip_mesh</code></strong>：跳过网格的提取和保存。</p>
</li>
<li>
<p><strong><code>--render_path</code></strong>：是否渲染路径视频。</p>
</li>
<li>
<p>网格参数</p>
<p>：</p>
<ul>
<li><strong><code>--voxel_size</code></strong>：体素大小。</li>
<li><strong><code>--depth_trunc</code></strong>：深度裁剪范围。</li>
<li><strong><code>--sdf_trunc</code></strong>：SDF（带符号距离场）的裁剪值。</li>
<li><strong><code>--num_cluster</code></strong>：导出的网格保留的最大连通簇数。</li>
<li><strong><code>--unbounded</code></strong>：是否启用无界网格模式。</li>
<li><strong><code>--mesh_res</code></strong>：无界网格的分辨率。</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"Rendering "</span> + args.model_path)</span><br></pre></td></tr></tbody></table></figure>
<p>打印当前的模型路径。</p>
<hr>
<h3 id="4-加载数据和模型">4. <strong>加载数据和模型</strong></h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dataset, iteration, pipe = model.extract(args), args.iteration, pipeline.extract(args)</span><br><span class="line">gaussians = GaussianModel(dataset.sh_degree)</span><br><span class="line">scene = Scene(dataset, gaussians, load_iteration=iteration, shuffle=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong><code>dataset</code></strong>：从命令行参数中提取数据集信息。</li>
<li><strong><code>iteration</code></strong>：加载指定迭代次数的模型。</li>
<li><strong><code>pipe</code></strong>：从命令行参数中提取渲染管道配置。</li>
<li><strong><code>GaussianModel</code></strong>：初始化高斯模型。</li>
<li><strong><code>Scene</code></strong>：创建场景对象，加载训练/测试数据和相机信息。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bg_color = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>] <span class="keyword">if</span> dataset.white_background <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">background = torch.tensor(bg_color, dtype=torch.float32, device=<span class="string">"cuda"</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong><code>bg_color</code></strong>：根据背景设置白色或黑色背景。</li>
<li><strong><code>background</code></strong>：将背景颜色转为PyTorch张量并移至GPU。</li>
</ul>
<hr>
<h3 id="5-设置输出目录">5. <strong>设置输出目录</strong></h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">train_dir = os.path.join(args.model_path, <span class="string">'train'</span>, <span class="string">"ours_{}"</span>.<span class="built_in">format</span>(scene.loaded_iter))</span><br><span class="line">test_dir = os.path.join(args.model_path, <span class="string">'test'</span>, <span class="string">"ours_{}"</span>.<span class="built_in">format</span>(scene.loaded_iter))</span><br><span class="line">gaussExtractor = GaussianExtractor(gaussians, render, pipe, bg_color=bg_color)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong><code>train_dir</code></strong> 和 <strong><code>test_dir</code></strong>：分别设置训练和测试图像的保存路径。</li>
<li><strong><code>gaussExtractor</code></strong>：初始化一个提取器对象，用于从高斯模型中生成图像或网格。</li>
</ul>
<hr>
<h3 id="6-导出训练图像">6. <strong>导出训练图像</strong></h3>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> args.skip_train:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"export training images ..."</span>)</span><br><span class="line">    os.makedirs(train_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    gaussExtractor.reconstruction(scene.getTrainCameras())</span><br><span class="line">    gaussExtractor.export_image(train_dir)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>
<p>条件检查</p>
<p>：如果没有跳过训练图像的导出：</p>
<ol>
<li>创建训练目录。</li>
<li>使用训练相机渲染图像。</li>
<li>保存渲染的图像到目录。</li>
</ol>
</li>
</ul>
<hr>
<h3 id="7-导出测试图像">7. <strong>导出测试图像</strong></h3>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">not</span> args.skip_test) <span class="keyword">and</span> (<span class="built_in">len</span>(scene.getTestCameras()) &gt; <span class="number">0</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"export rendered testing images ..."</span>)</span><br><span class="line">    os.makedirs(test_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    gaussExtractor.reconstruction(scene.getTestCameras())</span><br><span class="line">    gaussExtractor.export_image(test_dir)</span><br></pre></td></tr></tbody></table></figure>
<p>与训练图像类似，但使用测试相机生成并保存测试图像。</p>
<hr>
<h3 id="8-渲染路径视频">8. <strong>渲染路径视频</strong></h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> args.render_path:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"render videos ..."</span>)</span><br><span class="line">    traj_dir = os.path.join(args.model_path, <span class="string">'traj'</span>, <span class="string">"ours_{}"</span>.<span class="built_in">format</span>(scene.loaded_iter))</span><br><span class="line">    os.makedirs(traj_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    n_fames = <span class="number">240</span></span><br><span class="line">    cam_traj = generate_path(scene.getTrainCameras(), n_frames=n_fames)</span><br><span class="line">    gaussExtractor.reconstruction(cam_traj)</span><br><span class="line">    gaussExtractor.export_image(traj_dir)</span><br><span class="line">    create_videos(base_dir=traj_dir,</span><br><span class="line">                  input_dir=traj_dir,</span><br><span class="line">                  out_name=<span class="string">'render_traj'</span>,</span><br><span class="line">                  num_frames=n_fames)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>
<p>条件检查</p>
<p>：如果启用了路径渲染。</p>
<ol>
<li>创建路径目录。</li>
<li>生成240帧的相机路径。</li>
<li>渲染路径中的图像并保存。</li>
<li>将渲染的图像序列合成为视频。</li>
</ol>
</li>
</ul>
<hr>
<h3 id="9-导出网格">9. <strong>导出网格</strong></h3>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> args.skip_mesh:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"export mesh ..."</span>)</span><br><span class="line">    os.makedirs(train_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    gaussExtractor.gaussians.active_sh_degree = <span class="number">0</span></span><br><span class="line">    gaussExtractor.reconstruction(scene.getTrainCameras())</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>设置网格提取的初始条件，激活0阶球谐光照（仅提取漫反射纹理）。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> args.unbounded:</span><br><span class="line">    name = <span class="string">'fuse_unbounded.ply'</span></span><br><span class="line">    mesh = gaussExtractor.extract_mesh_unbounded(resolution=args.mesh_res)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    name = <span class="string">'fuse.ply'</span></span><br><span class="line">    depth_trunc = (gaussExtractor.radius * <span class="number">2.0</span>) <span class="keyword">if</span> args.depth_trunc &lt; <span class="number">0</span> <span class="keyword">else</span> args.depth_trunc</span><br><span class="line">    voxel_size = (depth_trunc / args.mesh_res) <span class="keyword">if</span> args.voxel_size &lt; <span class="number">0</span> <span class="keyword">else</span> args.voxel_size</span><br><span class="line">    sdf_trunc = <span class="number">5.0</span> * voxel_size <span class="keyword">if</span> args.sdf_trunc &lt; <span class="number">0</span> <span class="keyword">else</span> args.sdf_trunc</span><br><span class="line">    mesh = gaussExtractor.extract_mesh_bounded(voxel_size=voxel_size, sdf_trunc=sdf_trunc, depth_trunc=depth_trunc)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>无界模式</strong>：使用高分辨率生成网格。</li>
<li><strong>有界模式</strong>：根据体素大小、深度范围等参数生成网格。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">o3d.io.write_triangle_mesh(os.path.join(train_dir, name), mesh)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"mesh saved at {}"</span>.<span class="built_in">format</span>(os.path.join(train_dir, name)))</span><br></pre></td></tr></tbody></table></figure>
<p>保存提取的网格文件。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mesh_post = post_process_mesh(mesh, cluster_to_keep=args.num_cluster)</span><br><span class="line">o3d.io.write_triangle_mesh(os.path.join(train_dir, name.replace(<span class="string">'.ply'</span>, <span class="string">'_post.ply'</span>)), mesh_post)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"mesh post processed saved at {}"</span>.<span class="built_in">format</span>(os.path.join(train_dir, name.replace(<span class="string">'.ply'</span>, <span class="string">'_post.ply'</span>))))</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>对网格进行后处理，保留最大的连通簇。</li>
<li>保存后处理后的网格。</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">WangHao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/11/03/Trim2D-Code2/">http://example.com/2024/11/03/Trim2D-Code2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Trim3D/">Trim3D</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2024/10/21/xPiULZOrbcWpvtz.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2024/10/31/ACM-day13/" title="ACM-day13"><img class="cover" src="https://s2.loli.net/2024/10/29/MHki4smg8GNpZO9.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">ACM-day13</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/10/21/Trim2D-Code/" title="Trim2D_Code"><img class="cover" src="https://s2.loli.net/2024/10/21/xPiULZOrbcWpvtz.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-21</div><div class="title">Trim2D_Code</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/Avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">WangHao</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/574993075/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/574993075" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:w574993075@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#train-py"><span class="toc-number">1.</span> <span class="toc-text">train.py</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%BB%E4%BD%93"><span class="toc-number">1.1.</span> <span class="toc-text">代码主体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.</span> <span class="toc-text">代码详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%89%80%E9%9C%80%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.1.</span> <span class="toc-text">导入所需模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tensorboard-%E6%94%AF%E6%8C%81%E6%A3%80%E6%B5%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">TensorBoard 支持检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#training-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.3.</span> <span class="toc-text">training() 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%86%85%E9%83%A8%E4%BB%A3%E7%A0%81%E9%80%90%E8%A1%8C%E8%A7%A3%E9%87%8A"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">函数内部代码逐行解释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">背景设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E5%8F%98%E9%87%8F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">定时器和变量初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E5%BA%A6%E6%9D%A1%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">进度条设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E8%AE%AD%E7%BB%83%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.2.3.5.</span> <span class="toc-text">主训练循环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%AD%A6%E4%B9%A0%E7%8E%87%E8%B0%83%E6%95%B4"><span class="toc-number">1.2.3.6.</span> <span class="toc-text">动态学习率调整</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sh-%E5%BA%A6%E6%95%B0%E5%A2%9E%E5%8A%A0"><span class="toc-number">1.2.3.7.</span> <span class="toc-text">SH 度数增加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E9%9A%8F%E6%9C%BA%E8%A7%86%E8%A7%92"><span class="toc-number">1.2.3.8.</span> <span class="toc-text">选择随机视角</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E5%92%8C%E6%8D%9F%E5%A4%B1%E8%AE%A1%E7%AE%97"><span class="toc-number">1.2.3.9.</span> <span class="toc-text">渲染和损失计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97l1%E5%92%8Cssim%E6%8D%9F%E5%A4%B1"><span class="toc-number">1.2.3.10.</span> <span class="toc-text">计算L1和SSIM损失</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E5%8C%96%E8%AE%A1%E7%AE%97"><span class="toc-number">1.2.4.</span> <span class="toc-text">正则化计算</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%95%E5%90%91%E9%87%8F%E8%AF%AF%E5%B7%AE%E5%92%8C%E8%B7%9D%E7%A6%BB%E8%AF%AF%E5%B7%AE"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">法向量误差和距离误差</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E6%8D%9F%E5%A4%B1%E5%92%8C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">总损失和反向传播</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%AF%8F%E6%AC%A1%E8%BF%AD%E4%BB%A3%E7%9A%84%E6%97%B6%E9%97%B4"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">记录每次迭代的时间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%95%B0%E7%A7%BB%E5%8A%A8%E5%B9%B3%E5%9D%87-ema-%E8%AE%A1%E7%AE%97"><span class="toc-number">1.2.5.</span> <span class="toc-text">指数移动平均（EMA）计算</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%BF%9B%E5%BA%A6%E6%9D%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">更新进度条信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tensorboard-%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">TensorBoard 日志记录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8-training-report-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.6.</span> <span class="toc-text">调用 training_report 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E9%AB%98%E6%96%AF%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">保存高斯模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%AF%86%E5%BA%A6%E5%A2%9E%E5%BC%BA"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">执行密度增强</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%85%E9%99%A4%E4%B8%8D%E9%80%8F%E6%98%8E%E5%BA%A6"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">清除不透明度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.7.</span> <span class="toc-text">优化步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%82%B9%E4%BF%9D%E5%AD%98"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">检查点保存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prepare-output-and-logger-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.8.</span> <span class="toc-text">prepare_output_and_logger() 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6%E5%A4%B9%E5%88%9B%E5%BB%BA"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">输出文件夹创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="toc-number">1.2.8.2.</span> <span class="toc-text">配置日志记录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#training-report-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.9.</span> <span class="toc-text">training_report() 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%92%8C%E8%AE%AD%E7%BB%83%E9%9B%86%E6%B8%B2%E6%9F%93"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">测试和训练集渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%90%E4%B8%AA%E7%9B%B8%E6%9C%BA%E8%AE%A1%E7%AE%97l1%E5%92%8Cpsnr%E8%AF%AF%E5%B7%AE"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">逐个相机计算L1和PSNR误差</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%85%A5%E5%8F%A3"><span class="toc-number">1.2.10.</span> <span class="toc-text">主入口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cull-pcd-py"><span class="toc-number">2.</span> <span class="toc-text">cull_pcd.py</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%BB%E4%BD%93"><span class="toc-number">2.1.</span> <span class="toc-text">代码主体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.2.</span> <span class="toc-text">代码详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cull-pcd-%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.1.</span> <span class="toc-text">cull_pcd 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%86%85%E5%AE%B9"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">函数内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%94%E9%99%A4%E7%82%B9%E4%BA%91"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">剔除点云</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E7%82%B9%E4%BA%91%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">保存点云文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.2.</span> <span class="toc-text">主程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#tune-py"><span class="toc-number">3.</span> <span class="toc-text">tune.py</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%BB%E4%BD%93"><span class="toc-number">3.1.</span> <span class="toc-text">代码主体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.</span> <span class="toc-text">代码详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#culling-%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.1.</span> <span class="toc-text">culling 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prune-low-contribution-gaussians-%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.2.</span> <span class="toc-text">prune_low_contribution_gaussians 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#training-%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.3.</span> <span class="toc-text">training 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prepare-output-and-logger-%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.4.</span> <span class="toc-text">prepare_output_and_logger 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#training-report-%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.5.</span> <span class="toc-text">training_report 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%A8%8B%E5%BA%8F%E9%83%A8%E5%88%86"><span class="toc-number">3.2.6.</span> <span class="toc-text">主程序部分</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#render-py"><span class="toc-number">4.</span> <span class="toc-text">render.py</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%BB%E4%BD%93"><span class="toc-number">4.1.</span> <span class="toc-text">代码主体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.2.</span> <span class="toc-text">代码详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%89%80%E9%9C%80%E7%9A%84%E5%BA%93"><span class="toc-number">4.2.1.</span> <span class="toc-text">导入所需的库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%BB%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%A3"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. 主函数入口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AE%BE%E7%BD%AE%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">4.2.3.</span> <span class="toc-text">3. 设置命令行参数解析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%92%8C%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.2.4.</span> <span class="toc-text">4. 加载数据和模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%AE%BE%E7%BD%AE%E8%BE%93%E5%87%BA%E7%9B%AE%E5%BD%95"><span class="toc-number">4.2.5.</span> <span class="toc-text">5. 设置输出目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%AF%BC%E5%87%BA%E8%AE%AD%E7%BB%83%E5%9B%BE%E5%83%8F"><span class="toc-number">4.2.6.</span> <span class="toc-text">6. 导出训练图像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%AF%BC%E5%87%BA%E6%B5%8B%E8%AF%95%E5%9B%BE%E5%83%8F"><span class="toc-number">4.2.7.</span> <span class="toc-text">7. 导出测试图像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E6%B8%B2%E6%9F%93%E8%B7%AF%E5%BE%84%E8%A7%86%E9%A2%91"><span class="toc-number">4.2.8.</span> <span class="toc-text">8. 渲染路径视频</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%AF%BC%E5%87%BA%E7%BD%91%E6%A0%BC"><span class="toc-number">4.2.9.</span> <span class="toc-text">9. 导出网格</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/03/Trim2D-Code2/" title="Trim2D-Code2"><img src="https://s2.loli.net/2024/10/21/xPiULZOrbcWpvtz.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Trim2D-Code2"></a><div class="content"><a class="title" href="/2024/11/03/Trim2D-Code2/" title="Trim2D-Code2">Trim2D-Code2</a><time datetime="2024-11-03T14:14:38.000Z" title="Created 2024-11-03 22:14:38">2024-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/31/ACM-day13/" title="ACM-day13"><img src="https://s2.loli.net/2024/10/29/MHki4smg8GNpZO9.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ACM-day13"></a><div class="content"><a class="title" href="/2024/10/31/ACM-day13/" title="ACM-day13">ACM-day13</a><time datetime="2024-10-31T06:13:02.000Z" title="Created 2024-10-31 14:13:02">2024-10-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/30/ACM-day12/" title="ACM-day12"><img src="https://s2.loli.net/2024/10/28/rIlzOFnHpgRLbPX.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ACM-day12"></a><div class="content"><a class="title" href="/2024/10/30/ACM-day12/" title="ACM-day12">ACM-day12</a><time datetime="2024-10-30T08:37:40.000Z" title="Created 2024-10-30 16:37:40">2024-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/29/ACM-day11/" title="ACM-day11"><img src="https://s2.loli.net/2024/10/29/MHki4smg8GNpZO9.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ACM-day11"></a><div class="content"><a class="title" href="/2024/10/29/ACM-day11/" title="ACM-day11">ACM-day11</a><time datetime="2024-10-29T05:34:14.000Z" title="Created 2024-10-29 13:34:14">2024-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/28/ACM-day10/" title="ACM-day10"><img src="https://s2.loli.net/2024/10/28/rIlzOFnHpgRLbPX.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ACM-day10"></a><div class="content"><a class="title" href="/2024/10/28/ACM-day10/" title="ACM-day10">ACM-day10</a><time datetime="2024-10-28T04:05:42.000Z" title="Created 2024-10-28 12:05:42">2024-10-28</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2024 By WangHao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi! Welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://mytwikoo.b2wang.cn/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://mytwikoo.b2wang.cn/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))

    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.31/dist/twikoo.all.min.js').then(init)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>